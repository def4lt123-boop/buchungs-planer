<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/96/calendar--v1.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/96/calendar--v1.png">
    
    <title>Springerplan made by Flo - V4.1</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;900&family=Fraunces:wght@700;900&display=swap" rel="stylesheet">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }
        
        input, textarea { user-select: auto !important; }
        
        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #ffffff;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }
        
        /* Animated background particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 200, 50, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(100, 150, 255, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
            animation: floatBg 20s ease-in-out infinite;
        }
        
        @keyframes floatBg {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }
        
        /* Login Screen Styles */
        #login-screen {
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: linear-gradient(135deg, #0f0f0f 0%, #1f1f1f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .login-container {
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .login-logo-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: inline-block;
            animation: iconFloat 3s ease-in-out infinite;
        }
        
        @keyframes iconFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }
        
        .login-title {
            font-family: 'Fraunces', serif;
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, #FFC832 0%, #FF8C32 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }
        
        .login-subtitle {
            color: #888;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 2rem;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #FFC832, #FF8C32, #FFC832);
            background-size: 200% 100%;
            animation: shimmer 3s linear infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .input-group {
            margin-bottom: 1.25rem;
        }
        
        .input-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #999;
            margin-bottom: 0.5rem;
        }
        
        .input-field {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1rem 1.25rem;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
        }
        
        .input-field:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: #FFC832;
            box-shadow: 0 0 0 4px rgba(255, 200, 50, 0.1);
        }
        
        .input-field::placeholder {
            color: #555;
        }
        
        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, #FFC832 0%, #FF8C32 100%);
            border: none;
            border-radius: 1rem;
            padding: 1.25rem;
            color: #000;
            font-size: 1rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(255, 200, 50, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-primary:active::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(255, 200, 50, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            width: 100%;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1rem;
            color: #999;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }
        
        .btn-secondary:hover {
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
        }
        
        /* Main App Styles */
        .day-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 6px; 
            padding: 1rem;
        }
        
        .calendar-day { 
            aspect-ratio: 1/1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            border-radius: 1rem; 
            font-size: 0.8rem; 
            font-weight: 700; 
            cursor: pointer; 
            position: relative; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 2px solid transparent; 
            touch-action: manipulation;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .calendar-day:active {
            transform: scale(0.94);
        }
        
        .day-free { 
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white; 
        } 
        
        .day-busy { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white; 
        } 
        
        .day-pending { 
            background: linear-gradient(135deg, #FFC832 0%, #FF8C32 100%);
            color: black; 
        }
        
        .day-vacation { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .day-sick { 
            background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%);
            color: white; 
        }
        
        .day-planned-free { 
            background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);
            color: white;
        }
        
        .day-disabled { 
            background: #2a2a2a !important; 
            color: #555 !important; 
            cursor: not-allowed !important; 
            opacity: 0.4; 
            pointer-events: none;
            box-shadow: none !important;
        }
        
        .day-selected { 
            border: 3px solid #FFC832 !important; 
            transform: scale(0.95); 
            z-index: 10;
            box-shadow: 0 0 0 4px rgba(255, 200, 50, 0.2), 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        }
        
        .store-label { 
            font-size: 0.45rem; 
            background: rgba(0,0,0,0.5); 
            width: 100%; 
            text-align: center; 
            position: absolute; 
            bottom: 0; 
            border-radius: 0 0 0.85rem 0.85rem; 
            pointer-events: none;
            padding: 2px 0;
            font-weight: 600;
        }
        
        /* Action Bar */
        #action-bar { 
            position: fixed; 
            bottom: calc(20px + env(safe-area-inset-bottom)); 
            left: 50%; 
            transform: translate(-50%, 200%); 
            z-index: 9999; 
            width: 92%; 
            max-width: 420px;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        
        #action-bar.visible { 
            transform: translate(-50%, 0); 
            opacity: 1;
            pointer-events: auto;
        }
        
        .action-btn {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1.5rem;
            padding: 1rem 1.5rem;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.12);
        }
        
        /* Modals */
        .modal-overlay {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.7);
        }
        
        .modal-content {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2rem;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 450px;
            width: 92%;
        }
        
        .modal-header {
            font-family: 'Fraunces', serif;
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, #FFC832 0%, #FF8C32 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        /* Toast */
        .toast { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            color: white; 
            padding: 1rem 1.5rem; 
            border-radius: 1rem; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 10001;
            animation: slideInRight 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }
        
        @keyframes slideInRight { 
            from { transform: translateX(400px); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
        }
        
        /* Loading Spinner */
        .spinner { 
            border: 2px solid rgba(255,255,255,0.3); 
            border-radius: 50%; 
            border-top: 2px solid white; 
            width: 14px; 
            height: 14px; 
            animation: spin 0.8s linear infinite; 
            display: inline-block; 
            margin-right: 8px;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .btn-loading { 
            opacity: 0.6; 
            cursor: wait !important; 
            pointer-events: none; 
        }
        
        /* Offline Badge */
        .offline-badge { 
            position: fixed; 
            top: 10px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #ef4444; 
            color: white; 
            padding: 0.5rem 1.25rem; 
            border-radius: 2rem; 
            font-size: 0.75rem; 
            font-weight: 700; 
            z-index: 10002;
            animation: pulse 2s infinite;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
        
        /* Legend */
        .legend-item { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .legend-box { 
            width: 20px; 
            height: 20px; 
            border-radius: 6px; 
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        /* Sections */
        .section-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #FFC832;
            margin-bottom: 1rem;
        }
        
        /* Month Header */
        .month-header {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            font-weight: 900;
            text-align: center;
            margin: 2rem 0 1rem;
            background: linear-gradient(135deg, #FFC832 0%, #FF8C32 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Weekday Labels */
        .weekday-labels {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            padding: 0 1rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #888;
            text-align: center;
        }
        
        /* Button Styles */
        .btn-glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 0.75rem 1.25rem;
            color: white;
            font-weight: 700;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .btn-glass:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        #app-container { 
            padding-bottom: 140px !important;
            position: relative;
            z-index: 1;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Improved spacing for mobile */
        @media (max-width: 640px) {
            .login-title {
                font-size: 2rem;
            }
            
            .modal-content {
                padding: 1.5rem;
            }
            
            .month-header {
                font-size: 1.75rem;
            }
        }
    </style>
</head>
<body>
    
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-badge hidden">
        üî¥ Keine Internetverbindung
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="hidden">
        <div class="login-container">
            <div class="login-logo">
                <div class="login-logo-icon">üìÖ</div>
                <h1 class="login-title">Springerplan</h1>
                <p class="login-subtitle">V4.1 - Made by Flo</p>
            </div>
            
            <div class="login-card">
                <div class="input-group">
                    <label class="input-label" for="email">E-Mail</label>
                    <input type="email" id="email" class="input-field" placeholder="deine@email.com" autocomplete="email">
                </div>
                
                <div class="input-group">
                    <label class="input-label" for="password">Passwort</label>
                    <input type="password" id="password" class="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                </div>
                
                <div id="signup-fields" class="hidden">
                    <div class="input-group">
                        <label class="input-label" for="display_name">Dein Name</label>
                        <input type="text" id="display_name" class="input-field" placeholder="Max Mustermann">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label" for="store_number">Filiale</label>
                        <input type="text" id="store_number" class="input-field" placeholder="z.B. 123">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label" for="reg_code">Registrierungs-Code</label>
                        <input type="text" id="reg_code" class="input-field" placeholder="Code eingeben">
                    </div>
                </div>
                
                <button id="auth-btn-main" onclick="handleAuthAction()" class="btn-primary">
                    Login
                </button>
                
                <button id="toggle-auth-btn" onclick="toggleAuthMode()" class="btn-secondary">
                    Konto erstellen
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden" style="padding: 1rem;">
        
        <!-- Header -->
        <div class="section-card" style="text-align: center;">
            <h1 class="month-header" style="margin: 0;">üìÖ Springerplan</h1>
            <p style="color: #888; font-size: 0.85rem; margin-top: 0.5rem;" id="user-greeting">Hallo!</p>
            <button onclick="handleLogout()" class="btn-glass" style="margin-top: 1rem;">Abmelden</button>
        </div>

        <!-- Month Selector -->
        <div class="section-card">
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                <button onclick="changeMonth(-1)" class="btn-glass flex-1">‚Üê Vorheriger Monat</button>
                <button onclick="changeMonth(1)" class="btn-glass flex-1">N√§chster Monat ‚Üí</button>
            </div>
        </div>

        <!-- Calendar -->
        <div class="section-card">
            <h2 class="month-header" id="calendar-month-year">Monat Jahr</h2>
            <div class="weekday-labels">
                <div>Mo</div><div>Di</div><div>Mi</div><div>Do</div><div>Fr</div><div>Sa</div><div>So</div>
            </div>
            <div id="calendar-grid" class="day-grid"></div>
        </div>

        <!-- Legend -->
        <div class="section-card">
            <h3 class="section-title">Legende</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                <div class="legend-item"><div class="legend-box" style="background: linear-gradient(135deg, #22c55e, #16a34a);"></div>Frei</div>
                <div class="legend-item"><div class="legend-box" style="background: linear-gradient(135deg, #ef4444, #dc2626);"></div>Besetzt</div>
                <div class="legend-item"><div class="legend-box" style="background: linear-gradient(135deg, #FFC832, #FF8C32);"></div>Ausstehend</div>
                <div class="legend-item"><div class="legend-box" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"></div>Urlaub</div>
                <div class="legend-item"><div class="legend-box" style="background: linear-gradient(135deg, #991b1b, #7f1d1d);"></div>Krank</div>
                <div class="legend-item"><div class="legend-box" style="background: linear-gradient(135deg, #9333ea, #7e22ce);"></div>Geplant Frei</div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin-panel" class="hidden">
            <div class="section-card">
                <h3 class="section-title">‚öôÔ∏è Admin: Anfragen</h3>
                <div id="admin-list"></div>
            </div>
            
            <div class="section-card">
                <h3 class="section-title">üë• User Freischaltung</h3>
                <div id="user-approval-list"></div>
            </div>
        </div>

        <!-- User Bookings -->
        <div class="section-card">
            <h3 class="section-title">üìã Meine Buchungen</h3>
            <div id="booking-list"></div>
        </div>

    </div>

    <!-- Action Bar -->
    <div id="action-bar">
        <div style="display: flex; gap: 0.75rem; flex-direction: column;">
            <button onclick="bulkBookSelected()" class="action-btn" style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3);">
                <span id="selection-count">0</span> Tage buchen
            </button>
            <button onclick="clearSelection()" class="action-btn">
                Auswahl aufheben
            </button>
        </div>
    </div>

    <!-- Admin Action Bar -->
    <div id="admin-action-bar" class="hidden" style="position: fixed; bottom: calc(20px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); z-index: 9999; width: 92%; max-width: 420px;">
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
            <button onclick="adminAction('busy')" class="action-btn" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">BESETZT</button>
            <button onclick="adminAction('vacation')" class="action-btn" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;">URLAUB</button>
            <button onclick="adminAction('sick')" class="action-btn" style="background: linear-gradient(135deg, #991b1b, #7f1d1d); color: white;">KRANK</button>
            <button onclick="adminAction('planned_free')" class="action-btn" style="background: linear-gradient(135deg, #9333ea, #7e22ce); color: white;">GEPLANT FREI</button>
            <button onclick="adminAction('frei')" class="action-btn" style="grid-column: span 2;">FREIGEBEN</button>
            <button onclick="clearSelection()" class="action-btn" style="grid-column: span 2;">Auswahl aufheben</button>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="hidden fixed inset-0 z-[10000] modal-overlay flex items-center justify-center p-4">
        <div class="modal-content">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-zinc-400 hover:text-white font-bold text-2xl transition-colors">‚úï</button>
            <h3 class="modal-header">Details</h3>
            <p id="modal-date" class="text-sm text-zinc-400 font-semibold mb-6">DATUM</p>
            
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.1);">
                    <p style="font-size: 0.7rem; color: #888; text-transform: uppercase; font-weight: 700; margin-bottom: 0.5rem;">Gebucht von / Status</p>
                    <p id="modal-user" style="font-size: 0.95rem; font-weight: 700; color: white;">...</p>
                </div>

                <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.1);">
                    <p style="font-size: 0.7rem; color: #888; text-transform: uppercase; font-weight: 700; margin-bottom: 0.5rem;">Buchungsgrund</p>
                    <p id="modal-reason-user" style="font-size: 0.85rem; color: white; font-style: italic;">Keine Info</p>
                </div>

                <div id="admin-note-area" style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.1);">
                    <p style="font-size: 0.7rem; color: #888; text-transform: uppercase; font-weight: 700; margin-bottom: 0.5rem;">Anmerkung</p>
                    <textarea id="modal-reason-admin" style="width: 100%; background: rgba(255,255,255,0.08); color: white; font-size: 0.85rem; padding: 0.75rem; border-radius: 0.75rem; outline: none; border: 1px solid rgba(255,255,255,0.1); font-family: inherit;" rows="2" placeholder="Noch keine Anmerkung vorhanden..."></textarea>
                    <button id="btn-save-note" onclick="saveAdminNote()" class="hidden btn-primary" style="margin-top: 0.75rem; padding: 0.75rem;">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-[10000] modal-overlay flex items-center justify-center p-4">
        <div class="modal-content">
            <h3 class="modal-header">Best√§tigung</h3>
            <p id="confirm-message" style="font-size: 0.95rem; color: #ccc; margin-bottom: 2rem;"></p>
            <div style="display: flex; gap: 0.75rem;">
                <button onclick="cancelConfirm()" class="btn-glass flex-1" style="padding: 1rem;">Abbrechen</button>
                <button id="confirm-yes-btn" onclick="confirmAction()" class="btn-primary flex-1" style="padding: 1rem;">Best√§tigen</button>
            </div>
        </div>
    </div>

    <!-- Input Modal -->
    <div id="input-modal" class="hidden fixed inset-0 z-[10000] modal-overlay flex items-center justify-center p-4">
        <div class="modal-content">
            <h3 id="input-modal-title" class="modal-header">Eingabe</h3>
            <p id="input-modal-message" style="font-size: 0.9rem; color: #aaa; margin-bottom: 1.5rem;"></p>
            <textarea id="input-modal-field" class="input-field" rows="3" style="margin-bottom: 1.5rem;"></textarea>
            <div style="display: flex; gap: 0.75rem;">
                <button onclick="cancelInput()" class="btn-glass flex-1" style="padding: 1rem;">Abbrechen</button>
                <button id="input-modal-submit" onclick="submitInput()" class="btn-primary flex-1" style="padding: 1rem;">OK</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://njewqngqmwojsxhzycfq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5qZXdxbmdxbXdvanN4aHp5Y2ZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc5NzY2MTQsImV4cCI6MjA1MzU1MjYxNH0.HUDfg_Yd_EAa2bQ8M1Kb-6EbDnvqmxkItWU-TjDCU88';
        const ADMIN_EMAIL = 'f.a.schneller@icloud.com';
        const MASTER_REG_CODE = 'SPRINGER2025';
        const EJS_PUBLIC_KEY = 'LCtgbjhvBmVnCpj0c';
        const EJS_SERVICE = 'service_oy1k7d8';
        const EJS_USER_TEMPLATE = 'template_jb0pjpk';
        const EJS_ADMIN_TEMPLATE = 'template_j7vy28f';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentDate = new Date();
        let selectedDates = [];
        let allBookings = [];
        let confirmCallback = null;
        let inputCallback = null;

        // ============================================
        // INITIALIZATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Network status
            window.addEventListener('online', () => document.getElementById('offline-indicator').classList.add('hidden'));
            window.addEventListener('offline', () => document.getElementById('offline-indicator').classList.remove('hidden'));
            
            // Check auth state
            const { data: { user } } = await supabaseClient.auth.getUser();
            
            if (!user) {
                document.getElementById('login-screen').classList.remove('hidden');
            } else {
                const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
                if (!profile || !profile.is_approved) {
                    showToast('‚è≥ Dein Account wartet auf Freischaltung', 'info');
                    document.getElementById('login-screen').classList.remove('hidden');
                    return;
                }
                currentUser = { ...user, ...profile };
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('user-greeting').innerText = `Hallo, ${currentUser.display_name}! üëã`;
                
                if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                    document.getElementById('admin-panel').classList.remove('hidden');
                    renderUserApproval();
                }
                
                fetchAndRender();
            }
            
            // Subscribe to changes
            supabaseClient.channel('bookings-changes').on('postgres_changes', { event: '*', schema: 'public', table: 'bookings' }, () => fetchAndRender()).subscribe();
        });

        // ============================================
        // CALENDAR RENDERING
        // ============================================
        
        async function fetchAndRender() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startStr = firstDay.toISOString().split('T')[0];
            const endStr = lastDay.toISOString().split('T')[0];
            
            const { data } = await supabaseClient.from('bookings').select('*').gte('requested_date', startStr).lte('requested_date', endStr);
            allBookings = data || [];
            renderCalendar();
            renderLists(allBookings);
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayOfWeek = (firstDay.getDay() + 6) % 7;
            
            document.getElementById('calendar-month-year').innerText = firstDay.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                grid.appendChild(emptyCell);
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDateLoop = new Date(year, month, day);
                const dateStr = currentDateLoop.toISOString().split('T')[0];
                const dayBookings = allBookings.filter(b => b.requested_date === dateStr);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.innerText = day;
                
                const isPast = currentDateLoop < today;
                
                if (isPast) {
                    dayDiv.classList.add('day-disabled');
                } else if (dayBookings.length > 0) {
                    const booking = dayBookings[0];
                    if (booking.status === 'confirmed') dayDiv.classList.add('day-busy');
                    else if (booking.status === 'pending') dayDiv.classList.add('day-pending');
                    else if (booking.type === 'vacation') dayDiv.classList.add('day-vacation');
                    else if (booking.type === 'sick') dayDiv.classList.add('day-sick');
                    else if (booking.type === 'planned_free') dayDiv.classList.add('day-planned-free');
                    
                    if (booking.store_number) {
                        const label = document.createElement('div');
                        label.className = 'store-label';
                        label.innerText = `F${booking.store_number}`;
                        dayDiv.appendChild(label);
                    }
                    
                    dayDiv.onclick = () => openModal(booking);
                } else {
                    dayDiv.classList.add('day-free');
                    dayDiv.onclick = () => toggleDateSelection(dateStr, dayDiv);
                }
                
                if (selectedDates.includes(dateStr)) {
                    dayDiv.classList.add('day-selected');
                }
                
                grid.appendChild(dayDiv);
            }
            
            updateActionBar();
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            clearSelection();
            fetchAndRender();
        }

        // ============================================
        // DATE SELECTION
        // ============================================
        
        function toggleDateSelection(dateStr, element) {
            if (selectedDates.includes(dateStr)) {
                selectedDates = selectedDates.filter(d => d !== dateStr);
                element.classList.remove('day-selected');
            } else {
                selectedDates.push(dateStr);
                element.classList.add('day-selected');
            }
            updateActionBar();
        }

        function clearSelection() {
            selectedDates = [];
            document.querySelectorAll('.day-selected').forEach(el => el.classList.remove('day-selected'));
            updateActionBar();
        }

        function updateActionBar() {
            const isAdmin = currentUser && currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            const bar = document.getElementById(isAdmin ? 'admin-action-bar' : 'action-bar');
            const count = document.getElementById('selection-count');
            
            if (selectedDates.length > 0) {
                bar.classList.add('visible');
                if (count) count.innerText = selectedDates.length;
            } else {
                bar.classList.remove('visible');
            }
        }

        // ============================================
        // BOOKING FUNCTIONS
        // ============================================
        
        async function bulkBookSelected() {
            if (selectedDates.length === 0) return;
            
            showInput(
                'Buchung erstellen',
                `${selectedDates.length} Tage buchen. Optional: Grund angeben`,
                'z.B. "Wichtiger Termin"',
                async (reason) => {
                    const inserts = selectedDates.map(d => ({
                        user_id: currentUser.id,
                        user_email: currentUser.email,
                        display_name: currentUser.display_name,
                        store_number: currentUser.store_number,
                        requested_date: d,
                        status: 'pending',
                        type: 'booking',
                        reason_user: reason || null
                    }));
                    
                    await supabaseClient.from('bookings').insert(inserts);
                    
                    emailjs.init(EJS_PUBLIC_KEY);
                    const dateList = selectedDates.join(', ');
                    await emailjs.send(EJS_SERVICE, EJS_ADMIN_TEMPLATE, {
                        user_name: currentUser.display_name,
                        store_number: currentUser.store_number,
                        date: dateList,
                        reason: reason || 'Kein Grund angegeben'
                    });
                    
                    showToast('‚úÖ Anfrage gesendet!', 'success');
                    clearSelection();
                    fetchAndRender();
                }
            );
        }

        // ============================================
        // ADMIN FUNCTIONS
        // ============================================
        
        function adminAction(type) {
            if (selectedDates.length === 0) return;
            
            const insData = (t, display, by) => selectedDates.map(d => ({
                user_id: currentUser.id,
                user_email: ADMIN_EMAIL,
                display_name: display,
                store_number: currentUser.store_number,
                requested_date: d,
                status: 'confirmed',
                type: t,
                reason_admin: `Eingetragen von ${by}`
            }));
            
            if (type === 'busy') {
                showConfirm(
                    `${selectedDates.length} Tage als BESETZT markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('booking', 'BESETZT', 'Admin'));
                        showToast('‚úÖ Als Besetzt markiert', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'vacation') {
                showConfirm(
                    `${selectedDates.length} Tage als URLAUB markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('vacation', 'URLAUB', 'Admin'));
                        showToast('‚úÖ Als Urlaub markiert', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'sick') {
                showConfirm(
                    `${selectedDates.length} Tage als KRANK markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('sick', 'KRANK', 'Admin'));
                        showToast('‚úÖ Als Krank markiert', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'planned_free') {
                showConfirm(
                    `${selectedDates.length} Tage als GEPLANT FREI markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('planned_free', 'FREI', 'Admin'));
                        showToast('‚úÖ Geplant Frei eingetragen', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'frei') {
                showConfirm(
                    `${selectedDates.length} Tage FREIGEBEN (alle Buchungen l√∂schen)?`,
                    async () => {
                        await supabaseClient.from('bookings').delete().in('requested_date', selectedDates);
                        showToast('‚úÖ Tage freigegeben', 'success');
                        clearSelection();
                    }
                );
            }
        }

        async function renderUserApproval() {
            const list = document.getElementById('user-approval-list');
            const { data: users } = await supabaseClient.from('profiles').select('*').eq('is_approved', false);
            if (!users || users.length === 0) { 
                list.innerHTML = '<p style="font-size: 0.75rem; color: #666;">Keine neuen User</p>'; 
                return; 
            }
            list.innerHTML = '';
            users.forEach(u => {
                const userCard = document.createElement('div');
                userCard.style.cssText = 'background: rgba(255,255,255,0.08); padding: 1rem; border-radius: 1rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; border: 1px solid rgba(255,255,255,0.1);';
                userCard.innerHTML = `
                    <div style="font-weight: 700; font-size: 0.85rem;">
                        ${u.display_name}<br>
                        <span style="font-weight: 400; color: #888; font-size: 0.75rem;">Filiale ${u.store_number}</span>
                    </div>
                    <button onclick="approveUser('${u.id}')" class="btn-primary" style="padding: 0.75rem 1.25rem; font-size: 0.75rem;">OK</button>
                `;
                list.appendChild(userCard);
            });
        }

        async function approveUser(uid) { 
            await supabaseClient.from('profiles').update({ is_approved: true }).eq('id', uid); 
            showToast('‚úÖ User freigeschaltet', 'success');
            fetchAndRender(); 
        }

        function renderLists(data) {
            const uL = document.getElementById('booking-list');
            const aL = document.getElementById('admin-list');
            uL.innerHTML = ''; 
            
            const pending = data.filter(x => x.status === 'pending');
            
            if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                aL.innerHTML = pending.length ? '' : '<p style="font-size: 0.75rem; color: #666;">Keine Anfragen</p>';
                pending.forEach(b => {
                    const reqCard = document.createElement('div');
                    reqCard.style.cssText = 'background: rgba(255,255,255,0.08); padding: 1rem; border-radius: 1rem; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; font-weight: 700; margin-bottom: 0.75rem; border: 1px solid rgba(255,255,255,0.1);';
                    reqCard.innerHTML = `
                        <div>
                            ${b.requested_date}<br>
                            <span style="color: #888; font-size: 0.75rem;">${b.display_name}</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="processRequest(this, '${b.id}','confirmed','${b.user_email}','${b.requested_date}')" style="background: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.75rem; font-weight: 700; border: none; cursor: pointer;">‚úì</button>
                            <button onclick="processRequest(this, '${b.id}','rejected','${b.user_email}','${b.requested_date}')" style="background: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.75rem; font-weight: 700; border: none; cursor: pointer;">‚úï</button>
                        </div>
                    `;
                    aL.appendChild(reqCard);
                });
            }
            
            const userBookings = data.filter(x => x.user_id === currentUser.id).sort((a,b) => b.requested_date.localeCompare(a.requested_date));
            if (userBookings.length === 0) {
                uL.innerHTML = '<p style="font-size: 0.75rem; color: #666;">Noch keine Buchungen</p>';
            } else {
                userBookings.forEach(b => {
                    const bookCard = document.createElement('div');
                    bookCard.style.cssText = 'padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 1rem; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; font-weight: 700; border: 1px solid rgba(255,255,255,0.08); cursor: pointer; margin-bottom: 0.75rem;';
                    bookCard.onclick = () => openModal(b);
                    bookCard.innerHTML = `
                        <div>${b.requested_date}</div>
                        <div style="text-transform: uppercase; color: #FFC832; font-size: 0.75rem;">${b.status}</div>
                    `;
                    uL.appendChild(bookCard);
                });
            }
        }

        async function processRequest(btn, id, status, email, date) {
            if (status === 'rejected') {
                showInput(
                    'Anfrage ablehnen',
                    'Ablehnungsgrund (optional):',
                    'z.B. "An diesem Tag bereits verplant..."',
                    async (reason) => {
                        btn.innerText = '..';
                        await supabaseClient.from('bookings').update({ status, reason_admin: reason }).eq('id', id);
                        
                        if (email) {
                            emailjs.init(EJS_PUBLIC_KEY);
                            const adminNote = reason ? `Grund: ${reason}` : '';
                            await emailjs.send(EJS_SERVICE, EJS_USER_TEMPLATE, { 
                                email: email, 
                                status_text: 'ABGELEHNT', 
                                date: date,
                                admin_note: adminNote
                            });
                        }
                        showToast('‚úÖ Anfrage abgelehnt', 'success');
                        fetchAndRender();
                    }
                );
            } else {
                btn.innerText = '..';
                await supabaseClient.from('bookings').update({ status }).eq('id', id);
                
                if (email) {
                    emailjs.init(EJS_PUBLIC_KEY);
                    await emailjs.send(EJS_SERVICE, EJS_USER_TEMPLATE, { 
                        email: email, 
                        status_text: 'BEST√ÑTIGT', 
                        date: date,
                        admin_note: ''
                    });
                }
                showToast('‚úÖ Anfrage best√§tigt', 'success');
                fetchAndRender();
            }
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        
        function openModal(booking) {
            document.getElementById('modal-date').innerText = booking.requested_date;
            document.getElementById('modal-user').innerText = `${booking.display_name} (${booking.status.toUpperCase()})`;
            document.getElementById('modal-reason-user').innerText = booking.reason_user || 'Keine Info';
            
            const adminArea = document.getElementById('admin-note-area');
            const adminField = document.getElementById('modal-reason-admin');
            const saveBtn = document.getElementById('btn-save-note');
            
            if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                adminArea.classList.remove('hidden');
                adminField.value = booking.reason_admin || '';
                adminField.dataset.bookingId = booking.id;
                
                adminField.oninput = () => {
                    saveBtn.classList.remove('hidden');
                };
            } else {
                adminArea.classList.add('hidden');
            }
            
            document.getElementById('detail-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        async function saveAdminNote() {
            const field = document.getElementById('modal-reason-admin');
            const bookingId = field.dataset.bookingId;
            const note = field.value;
            
            await supabaseClient.from('bookings').update({ reason_admin: note }).eq('id', bookingId);
            showToast('‚úÖ Anmerkung gespeichert', 'success');
            document.getElementById('btn-save-note').classList.add('hidden');
            fetchAndRender();
        }

        // ============================================
        // CONFIRM & INPUT MODALS
        // ============================================
        
        function showConfirm(message, callback) {
            document.getElementById('confirm-message').innerText = message;
            document.getElementById('confirm-modal').classList.remove('hidden');
            confirmCallback = callback;
        }

        function confirmAction() {
            document.getElementById('confirm-modal').classList.add('hidden');
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
            }
        }

        function cancelConfirm() {
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmCallback = null;
        }

        function showInput(title, message, placeholder, callback) {
            document.getElementById('input-modal-title').innerText = title;
            document.getElementById('input-modal-message').innerText = message;
            document.getElementById('input-modal-field').placeholder = placeholder;
            document.getElementById('input-modal-field').value = '';
            document.getElementById('input-modal').classList.remove('hidden');
            inputCallback = callback;
        }

        function submitInput() {
            const value = document.getElementById('input-modal-field').value;
            document.getElementById('input-modal').classList.add('hidden');
            if (inputCallback) {
                inputCallback(value);
                inputCallback = null;
            }
        }

        function cancelInput() {
            document.getElementById('input-modal').classList.add('hidden');
            inputCallback = null;
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================
        
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============================================
        // AUTH FUNCTIONS
        // ============================================
        
        function setBtnLoading(id, isLoading, text = '...') {
            const btn = document.getElementById(id);
            if (isLoading) {
                btn.classList.add('btn-loading');
                btn.innerHTML = `<span class="spinner"></span>${text}`;
            } else {
                btn.classList.remove('btn-loading');
            }
        }

        async function handleAuthAction() {
            setBtnLoading('auth-btn-main', true, "...");
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                if (document.getElementById('signup-fields').classList.contains('hidden')) {
                    // Login
                    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    location.reload();
                } else {
                    // Register
                    const name = document.getElementById('display_name').value;
                    const store = document.getElementById('store_number').value;
                    const code = document.getElementById('reg_code').value;
                    
                    if (code.toUpperCase() !== MASTER_REG_CODE) throw new Error("Registrierungs-Code falsch");
                    
                    const { error } = await supabaseClient.auth.signUp({ 
                        email, 
                        password, 
                        options: { 
                            data: { display_name: name, store_number: store } 
                        } 
                    });
                    
                    if (error) throw error;
                    
                    emailjs.init(EJS_PUBLIC_KEY);
                    await emailjs.send(EJS_SERVICE, EJS_ADMIN_TEMPLATE, { 
                        user_name: name, 
                        store_number: store, 
                        date: "NEUE ANMELDUNG", 
                        reason: "Wartet auf Freischaltung" 
                    });
                    
                    showToast('‚úÖ Registriert! Warte auf Freischaltung.', 'success');
                    location.reload();
                }
            } catch (err) { 
                showToast('‚ùå ' + err.message, 'error');
                setBtnLoading('auth-btn-main', false); 
            }
        }

        function toggleAuthMode() { 
            const isHidden = document.getElementById('signup-fields').classList.toggle('hidden'); 
            document.getElementById('toggle-auth-btn').innerText = isHidden ? "Konto erstellen" : "Zum Login"; 
            document.getElementById('auth-btn-main').innerText = isHidden ? "Login" : "Registrieren"; 
        }

        async function handleLogout() { 
            await supabaseClient.auth.signOut(); 
            location.reload(); 
        }
    </script>
</body>
</html>
