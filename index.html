<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#18181b">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/96/calendar--v1.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/96/calendar--v1.png">
    
    <title>Springerplan made by Flo - V4.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        .day-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.7rem; font-weight: bold; cursor: pointer; position: relative; transition: transform 0.1s ease; border: 2px solid transparent; touch-action: manipulation; }
        
        .day-free { background-color: #22c55e; color: white; } 
        .day-busy { background-color: #ef4444; color: white; } 
        .day-pending { background-color: #eab308; color: black; }
        .day-vacation { background-color: #3b82f6; color: white; }
        .day-sick { background-color: #7f1d1d; color: white; border: 1px solid #f87171; }
        .day-planned-free { background-color: #9333ea; color: white; }
        
        .day-disabled { background-color: #3f3f46 !important; color: #71717a !important; cursor: not-allowed !important; opacity: 0.5; pointer-events: none; }
        .day-selected { border: 3px solid #ffffff !important; transform: scale(0.92); z-index: 10; }
        .store-label { font-size: 0.4rem; background: rgba(0,0,0,0.4); width: 100%; text-align: center; position: absolute; bottom: 0; border-radius: 0 0 10px 10px; pointer-events: none; }
        
        .spinner { border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 2px solid white; width: 12px; height: 12px; animation: spin 1s linear infinite; display: inline-block; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-loading { opacity: 0.7; cursor: wait !important; pointer-events: none; }

        #detail-modal, #confirm-modal, #input-modal { backdrop-filter: blur(5px); }
        
        #action-bar { 
            position: fixed; 
            bottom: calc(20px + env(safe-area-inset-bottom)); 
            left: 50%; 
            transform: translate(-50%, 200%); 
            z-index: 9999; 
            width: 92%; 
            max-width: 400px;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        #action-bar.visible { 
            transform: translate(-50%, 0); 
            opacity: 1;
            pointer-events: auto;
        }
        #app-container { padding-bottom: 120px !important; }
        
        * { user-select: none; -webkit-tap-highlight-color: transparent; }
        input, textarea { user-select: auto !important; }

        /* Legend Styles */
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.65rem; }
        .legend-box { width: 16px; height: 16px; border-radius: 4px; flex-shrink: 0; }

        /* Toast Notification */
        .toast { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: #18181b; 
            color: white; 
            padding: 12px 20px; 
            border-radius: 12px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 10001;
            animation: slideIn 0.3s ease;
            border: 1px solid #3f3f46;
        }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Offline Indicator */
        .offline-badge { 
            position: fixed; 
            top: 10px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #ef4444; 
            color: white; 
            padding: 6px 16px; 
            border-radius: 20px; 
            font-size: 0.65rem; 
            font-weight: bold; 
            z-index: 10002;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="bg-black text-white font-sans overflow-x-hidden">
    
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-badge hidden">
        üî¥ Keine Internetverbindung
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="hidden fixed inset-0 z-[10000] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-zinc-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl border border-zinc-700 relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-zinc-500 font-bold text-xl">‚úï</button>
            <h3 class="text-yellow-500 font-black uppercase text-lg mb-1">Details</h3>
            <p id="modal-date" class="text-xs text-zinc-400 font-bold mb-4">DATUM</p>
            
            <div class="space-y-4">
                <div class="bg-zinc-900 p-3 rounded-xl border border-zinc-700">
                    <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">Gebucht von / Status</p>
                    <p id="modal-user" class="text-sm font-bold text-white">...</p>
                </div>

                <div class="bg-zinc-900 p-3 rounded-xl border border-zinc-700">
                    <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">Buchungsgrund (optional)</p>
                    <p id="modal-reason-user" class="text-xs text-white italic">Keine Info</p>
                </div>

                <div id="admin-note-area" class="bg-zinc-900 p-3 rounded-xl border border-zinc-700">
                    <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">Anmerkung</p>
                    <textarea id="modal-reason-admin" class="w-full bg-zinc-800 text-white text-xs p-2 rounded-lg outline-none" rows="2" placeholder="Noch keine Anmerkung vorhanden..."></textarea>
                    <button id="btn-save-note" onclick="saveAdminNote()" class="hidden w-full mt-2 bg-yellow-500 text-black text-[9px] font-black py-2 rounded-lg uppercase">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-[10000] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-zinc-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl border border-zinc-700">
            <h3 class="text-yellow-500 font-black uppercase text-lg mb-2">Best√§tigung</h3>
            <p id="confirm-message" class="text-sm text-zinc-300 mb-6"></p>
            <div class="flex gap-3">
                <button onclick="cancelConfirm()" class="flex-1 bg-zinc-700 text-white py-3 rounded-xl font-bold text-sm">Abbrechen</button>
                <button id="confirm-yes-btn" onclick="confirmAction()" class="flex-1 bg-yellow-500 text-black py-3 rounded-xl font-bold text-sm">Best√§tigen</button>
            </div>
        </div>
    </div>

    <!-- Input Modal (replaces prompt()) -->
    <div id="input-modal" class="hidden fixed inset-0 z-[10000] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-zinc-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl border border-zinc-700">
            <h3 id="input-title" class="text-yellow-500 font-black uppercase text-lg mb-2">Eingabe</h3>
            <p id="input-label" class="text-xs text-zinc-400 mb-3"></p>
            <input id="input-field" type="text" class="w-full p-4 bg-zinc-900 text-white rounded-xl outline-none border border-zinc-700" placeholder="">
            <div class="flex gap-3 mt-4">
                <button onclick="cancelInput()" class="flex-1 bg-zinc-700 text-white py-3 rounded-xl font-bold text-sm">Abbrechen</button>
                <button onclick="submitInput()" class="flex-1 bg-yellow-500 text-black py-3 rounded-xl font-bold text-sm">OK</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="max-w-md mx-auto min-h-screen p-4 bg-zinc-900 shadow-2xl pb-60 relative">
        
        <!-- Status Banner -->
        <div id="status-banner" class="hidden mb-6 p-4 rounded-2xl text-center shadow-lg border-2">
            <h2 id="status-headline" class="text-sm font-black uppercase mb-1"></h2>
            <p id="status-subline" class="text-[10px] font-bold opacity-80"></p>
        </div>

        <!-- Loading Screen -->
        <div id="loading" class="flex flex-col items-center py-20 text-yellow-500 font-bold animate-pulse text-xs">
            SYSTEM STARTET...
        </div>

        <!-- Error Display -->
        <div id="error-display" class="hidden py-20 text-center text-red-500 px-10">
            <p class="font-bold">FEHLER BEIM LADEN</p>
            <p id="error-msg" class="text-[10px] mt-2 text-zinc-500"></p>
            <button onclick="handleLogout()" class="mt-5 text-white underline bg-zinc-800 px-4 py-2 rounded">Notfall Logout</button>
        </div>

        <!-- Auth Section -->
        <div id="auth-section" class="hidden py-10 text-center">
            <h1 class="text-3xl font-black mb-1 text-yellow-500 italic uppercase">Springerplan</h1>
            <p class="text-[10px] font-bold text-zinc-400 uppercase mb-8">made by Flo</p>
            <div class="space-y-3 px-4">
                <input id="email" type="email" placeholder="E-Mail" class="w-full p-4 bg-zinc-800 rounded-2xl outline-none">
                <input id="password" type="password" placeholder="Passwort" class="w-full p-4 bg-zinc-800 rounded-2xl outline-none">
                
                <div id="signup-fields" class="hidden space-y-3 pt-2">
                    <input id="display_name" type="text" placeholder="Dein Name" class="w-full p-4 bg-zinc-800 rounded-2xl outline-none">
                    <input id="store_number" type="text" placeholder="Filiale" class="w-full p-4 bg-zinc-800 rounded-2xl outline-none">
                    <input id="reg_code" type="text" placeholder="Registrierungs-Code" class="w-full p-4 bg-zinc-800 rounded-2xl outline-none">
                </div>
                
                <button id="auth-btn-main" onclick="handleAuthAction()" class="w-full bg-yellow-500 text-black font-black py-4 rounded-2xl uppercase text-sm">Login</button>
                <button id="toggle-auth-btn" onclick="toggleAuthMode()" class="text-zinc-500 text-[10px] underline">Konto erstellen</button>
            </div>
        </div>

        <!-- Main App Content -->
        <div id="main-section" class="hidden space-y-6">
            
            <!-- User Info Header -->
            <div class="bg-zinc-800 p-5 rounded-3xl border border-zinc-700">
                <p id="user-welcome" class="text-lg font-black text-yellow-500"></p>
                <p id="user-store" class="text-[10px] text-zinc-400 font-bold"></p>
                <button onclick="handleLogout()" class="mt-3 text-red-400 underline text-[9px] font-bold">Logout</button>
            </div>

            <!-- Color Legend -->
            <div class="bg-zinc-800 p-4 rounded-2xl border border-zinc-700">
                <h3 class="text-[9px] text-zinc-500 uppercase font-bold mb-3">Farblegende</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div class="legend-item"><div class="legend-box day-free"></div><span>Frei</span></div>
                    <div class="legend-item"><div class="legend-box day-busy"></div><span>Gebucht</span></div>
                    <div class="legend-item"><div class="legend-box day-pending"></div><span>Anfrage</span></div>
                    <div class="legend-item"><div class="legend-box day-vacation"></div><span>Urlaub</span></div>
                    <div class="legend-item"><div class="legend-box day-sick"></div><span>Krank</span></div>
                    <div class="legend-item"><div class="legend-box day-planned-free"></div><span>Geplant Frei</span></div>
                </div>
            </div>

            <!-- Calendar Section -->
            <div class="bg-zinc-800 p-5 rounded-3xl border border-zinc-700">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1)" class="bg-zinc-700 w-10 h-10 rounded-full font-black text-lg">‚Üê</button>
                    <h2 id="month-name" class="text-sm font-black uppercase text-yellow-500">MONAT</h2>
                    <button onclick="changeMonth(1)" class="bg-zinc-700 w-10 h-10 rounded-full font-black text-lg">‚Üí</button>
                </div>
                
                <div class="day-grid text-[8px] text-zinc-500 font-bold mb-2">
                    <div class="text-center">MO</div><div class="text-center">DI</div><div class="text-center">MI</div><div class="text-center">DO</div><div class="text-center">FR</div><div class="text-center">SA</div><div class="text-center">SO</div>
                </div>
                
                <div id="calendar-grid" class="day-grid"></div>
            </div>

            <!-- User Bookings List -->
            <div class="bg-zinc-800 p-5 rounded-3xl border border-zinc-700">
                <h3 class="text-[9px] text-zinc-500 uppercase font-bold mb-3">Meine Buchungen</h3>
                <div id="booking-list" class="space-y-2"></div>
            </div>

            <!-- Admin Panel -->
            <div id="admin-panel" class="hidden space-y-6">
                
                <!-- Admin Status Toggle -->
                <div class="bg-yellow-500 text-black p-5 rounded-3xl">
                    <h3 class="text-[9px] uppercase font-black mb-3">Admin Status</h3>
                    <div class="flex gap-2">
                        <button id="status-sick-state" onclick="toggleGlobalStatus('sick')" class="flex-1 bg-red-600 text-white font-black py-3 rounded-xl text-[10px] uppercase">Krank: AUS</button>
                        <button id="status-vacation-state" onclick="toggleGlobalStatus('vacation')" class="flex-1 bg-blue-600 text-white font-black py-3 rounded-xl text-[10px] uppercase">Urlaub: AUS</button>
                    </div>
                </div>

                <!-- Admin Calendar -->
                <div class="bg-red-900/20 border-2 border-red-500 p-5 rounded-3xl">
                    <h3 class="text-red-500 font-black text-sm uppercase mb-4">Admin Kalender-Editor</h3>
                    <div class="day-grid text-[8px] text-zinc-500 font-bold mb-2">
                        <div class="text-center">MO</div><div class="text-center">DI</div><div class="text-center">MI</div><div class="text-center">DO</div><div class="text-center">FR</div><div class="text-center">SA</div><div class="text-center">SO</div>
                    </div>
                    <div id="admin-calendar-grid" class="day-grid"></div>
                </div>

                <!-- Pending Requests -->
                <div class="bg-zinc-800 p-5 rounded-3xl border border-zinc-700">
                    <h3 class="text-[9px] text-zinc-500 uppercase font-bold mb-3">Offene Anfragen</h3>
                    <div id="admin-list" class="space-y-2"></div>
                </div>

                <!-- User Approval -->
                <div class="bg-zinc-800 p-5 rounded-3xl border border-zinc-700">
                    <h3 class="text-[9px] text-zinc-500 uppercase font-bold mb-3">Neue User freischalten</h3>
                    <div id="user-approval-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Bar (floating bottom) -->
    <div id="action-bar" class="bg-yellow-500 text-black rounded-[2rem] p-4 shadow-2xl">
        <p id="selection-info" class="text-center font-black text-[10px] mb-3 uppercase">0 Tage ausgew√§hlt</p>
        
        <!-- User Actions -->
        <button id="btn-submit" onclick="submitSelection()" class="w-full bg-black text-yellow-500 font-black py-3 rounded-xl uppercase text-sm mb-2">Anfrage senden</button>
        
        <!-- Admin Actions -->
        <div id="admin-actions" class="hidden space-y-2 pt-2 border-t-2 border-black/20">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="submitAdminAction('direkt')" class="bg-red-600 text-white font-black py-2 rounded-lg text-[9px] uppercase">Direkt buchen</button>
                <button onclick="submitAdminAction('urlaub')" class="bg-blue-600 text-white font-black py-2 rounded-lg text-[9px] uppercase">Urlaub</button>
                <button onclick="submitAdminAction('krank')" class="bg-red-900 text-white font-black py-2 rounded-lg text-[9px] uppercase">Krank</button>
                <button onclick="submitAdminAction('planned_free')" class="bg-purple-600 text-white font-black py-2 rounded-lg text-[9px] uppercase">Geplant Frei</button>
            </div>
            <button onclick="submitAdminAction('frei')" class="w-full bg-green-600 text-white font-black py-2 rounded-lg text-[9px] uppercase">Tage freigeben</button>
        </div>
        
        <button onclick="clearSelection()" class="w-full mt-2 text-black/60 underline text-[9px] font-bold">Auswahl l√∂schen</button>
    </div>

    <script>
        // ============================================
        // KONFIGURATION - HIER DEINE DATEN EINTRAGEN
        // ============================================
        
        const SUPABASE_URL = "https://aggpjaxpupqbsefsusok.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnZ3BqYXhwdXBxYnNlZnN1c29rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNzgxOTcsImV4cCI6MjA4NTg1NDE5N30.66Q-q1EIdn4_EWf_TCOanxwQ-_qB6-FaAYdHCYbLkHk"; // NUR ANON KEY!
        
        // EmailJS Konfiguration
        const EJS_PUBLIC_KEY = "MkRGHMZNkwKnmQDLY";
        const EJS_SERVICE = "service_z1cwhnt";
        const EJS_ADMIN_TEMPLATE = "template_avultfe";
        const EJS_USER_TEMPLATE = "template_22cjt73";
        
        // Admin-Email (wird aus Datenbank gelesen, siehe SQL)
        const ADMIN_EMAIL = "def4lt123@gmail.com"; // Backup-Wert
        
        // Registrierungs-Code
        const MASTER_REG_CODE = "FLO2026";
        
        // ============================================
        // GLOBALE VARIABLEN
        // ============================================
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null, userProfile = null, selectedDates = [], currentViewDate = new Date(), currentModalBookingId = null;
        
        let confirmCallback = null, inputCallback = null;

        // ============================================
        // INITIALISIERUNG
        // ============================================
        
        window.addEventListener('load', init);
        
        // Offline Detection
        window.addEventListener('online', () => {
            document.getElementById('offline-indicator').classList.add('hidden');
            showToast('‚úÖ Verbindung wiederhergestellt', 'success');
        });
        window.addEventListener('offline', () => {
            document.getElementById('offline-indicator').classList.remove('hidden');
        });

        async function init() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (!session) {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('auth-section').classList.remove('hidden');
                    return;
                }
                
                currentUser = session.user;
                const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
                
                if (!profile) throw new Error("Profil nicht gefunden");
                if (!profile.is_approved) {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('error-display').classList.remove('hidden');
                    document.getElementById('error-msg').innerText = "Dein Account wurde noch nicht freigeschaltet. Bitte warte auf Flos Best√§tigung.";
                    return;
                }
                
                userProfile = profile;
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-section').classList.remove('hidden');
                
                await loadGlobalStatus();
                renderUserSection();
                
            } catch (err) {
                console.error(err);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error-display').classList.remove('hidden');
                document.getElementById('error-msg').innerText = err.message;
            }
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#18181b';
            toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function setBtnLoading(btnId, isLoading, text = '') {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            if (isLoading) {
                btn.classList.add('btn-loading');
                btn.innerHTML = `<span class="spinner"></span>${text}`;
            } else {
                btn.classList.remove('btn-loading');
                btn.innerHTML = btn.getAttribute('data-original-text') || text;
            }
        }

        // Modal Helpers
        function showConfirm(message, callback) {
            document.getElementById('confirm-message').innerText = message;
            document.getElementById('confirm-modal').classList.remove('hidden');
            confirmCallback = callback;
        }

        function cancelConfirm() {
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmCallback = null;
        }

        function confirmAction() {
            document.getElementById('confirm-modal').classList.add('hidden');
            if (confirmCallback) confirmCallback();
            confirmCallback = null;
        }

        function showInput(title, label, placeholder, callback) {
            document.getElementById('input-title').innerText = title;
            document.getElementById('input-label').innerText = label;
            document.getElementById('input-field').placeholder = placeholder;
            document.getElementById('input-field').value = '';
            document.getElementById('input-modal').classList.remove('hidden');
            inputCallback = callback;
        }

        function cancelInput() {
            document.getElementById('input-modal').classList.add('hidden');
            if (inputCallback) inputCallback(null);
            inputCallback = null;
        }

        function submitInput() {
            const value = document.getElementById('input-field').value;
            document.getElementById('input-modal').classList.add('hidden');
            if (inputCallback) inputCallback(value);
            inputCallback = null;
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        // ============================================
        // USER SECTION
        // ============================================

        function renderUserSection() {
            if (!userProfile) return;
            document.getElementById('user-welcome').innerText = userProfile.display_name;
            document.getElementById('user-store').innerText = 'Filiale: ' + userProfile.store_number;
            const isAdmin = currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            document.getElementById('admin-panel').classList.toggle('hidden', !isAdmin);
            fetchAndRender();
        }

        async function fetchAndRender() {
            const { data: bookings } = await supabaseClient.from('bookings').select('*');
            renderCalendar('calendar-grid', bookings || [], false); 
            if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                renderCalendar('admin-calendar-grid', bookings || [], true);
                renderUserApproval();
            }
            renderLists(bookings || []);
        }

        async function loadGlobalStatus() {
            const { data, error } = await supabaseClient.from('profiles').select('admin_status').eq('email', ADMIN_EMAIL).maybeSingle();
            if (data) {
                renderGlobalBanner(data.admin_status);
            }
        }

        function renderGlobalBanner(status) {
            const banner = document.getElementById('status-banner');
            const h = document.getElementById('status-headline');
            const s = document.getElementById('status-subline');
            
            const btnSick = document.getElementById('status-sick-state');
            const btnVac = document.getElementById('status-vacation-state');
            if(btnSick) btnSick.innerText = (status === 'sick' ? 'Krank: AN' : 'Krank: AUS');
            if(btnVac) btnVac.innerText = (status === 'vacation' ? 'Urlaub: AN' : 'Urlaub: AUS');

            if (status === 'sick') {
                banner.classList.remove('hidden');
                banner.className = "mb-6 p-4 rounded-2xl text-center shadow-lg border-2 border-red-500 bg-red-900/20 text-red-500 animate-pulse";
                h.innerText = "Flo befindet sich derzeit im Krankenstand.";
                s.innerText = "Anfragen werden eventuell erst sp√§ter bearbeitet.";
            } else if (status === 'vacation') {
                banner.classList.remove('hidden');
                banner.className = "mb-6 p-4 rounded-2xl text-center shadow-lg border-2 border-blue-500 bg-blue-900/20 text-blue-400 animate-pulse";
                h.innerText = "Flo ist derzeit im Urlaub.";
                s.innerText = "Anfragen werden eventuell erst sp√§ter bearbeitet.";
            } else {
                banner.classList.add('hidden');
            }
        }

        async function toggleGlobalStatus(type) {
            try {
                let { data } = await supabaseClient.from('profiles').select('admin_status').eq('id', currentUser.id).maybeSingle();
                const newStatus = (data && data.admin_status === type) ? null : type;
                
                const { error } = await supabaseClient.from('profiles').update({ admin_status: newStatus }).eq('id', currentUser.id);
                
                if (error) {
                    showToast('‚ùå Fehler: ' + error.message, 'error');
                } else {
                    location.reload(); 
                }
            } catch (err) { 
                showToast('‚ùå System-Fehler: ' + err.message, 'error');
            }
        }

        // ============================================
        // CALENDAR RENDERING
        // ============================================

        function isAustrianHoliday(date) {
            const y = date.getFullYear(), m = date.getMonth() + 1, d = date.getDate();
            const fixed = ['1.1.', '6.1.', '1.5.', '15.8.', '26.10.', '1.11.', '25.12.', '26.12.'];
            if (fixed.includes(`${d}.${m}.`)) return true;
            const a = y % 19, b = Math.floor(y / 100), c = y % 100, d1 = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25), g = Math.floor((b - f + 1) / 3), h = (19 * a + b - d1 - g + 15) % 30, i = Math.floor(c / 4), k = c % 4, l = (32 + 2 * e + 2 * i - h - k) % 7, m1 = Math.floor((a + 11 * h + 22 * l) / 451), month = Math.floor((h + l - 7 * m1 + 114) / 31), day = ((h + l - 7 * m1 + 114) % 31) + 1;
            const easter = new Date(y, month - 1, day);
            const addDays = (base, n) => { let res = new Date(base); res.setDate(res.getDate() + n); return res; };
            const check = (target) => d === target.getDate() && (m - 1) === target.getMonth();
            return check(addDays(easter, 1)) || check(addDays(easter, 39)) || check(addDays(easter, 50)) || check(addDays(easter, 60));
        }

        function renderCalendar(targetId, allBookings, isArchiveMode) {
            const grid = document.getElementById(targetId);
            if (!grid) return; grid.innerHTML = '';
            
            const year = currentViewDate.getFullYear(), month = currentViewDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDay = (new Date(year, month, 1).getDay() + 6) % 7;
            
            // FIX: String-Vergleich statt Date-Objekt-Vergleich
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            if (targetId === 'calendar-grid') {
                document.getElementById('month-name').innerText = new Intl.DateTimeFormat('de-DE', { month: 'long', year: 'numeric' }).format(currentViewDate);
            }
            
            for (let x = 0; x < startDay; x++) grid.innerHTML += `<div></div>`;
            
            for (let d = 1; d <= daysInMonth; d++) {
                const dateObj = new Date(year, month, d);
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const b = allBookings.find(x => x.requested_date === dateStr && x.status !== 'rejected');
                let cls = "day-free", label = "", disabled = false, isBusy = false;
                
                // FIX: String-Vergleich f√ºr vergangene Tage
                if (!isArchiveMode) { 
                    if (dateStr < todayStr || dateObj.getDay() === 0 || isAustrianHoliday(dateObj)) { 
                        disabled = true; 
                        cls = "day-disabled"; 
                    } 
                }
                
                if (b) {
                    isBusy = true; 
                    if (b.status === 'confirmed') { cls = "day-busy"; label = "Fil. " + b.store_number; }
                    else if (b.status === 'pending') { cls = "day-pending"; label = "OFFEN"; }
                    else if (b.status === 'vacation') { cls = "day-vacation"; label = "URLAUB"; }
                    else if (b.status === 'sick') { cls = "day-sick"; label = "KRANK"; }
                    else if (b.status === 'planned_free') { cls = "day-planned-free"; label = "FREI"; }
                }
                
                const isSelected = selectedDates.includes(dateStr) ? 'day-selected' : '';
                const bookingData = b ? JSON.stringify(b).replace(/"/g, '&quot;') : null;
                let clickAction = '';
                
                if (!disabled) { 
                    if (isArchiveMode) { clickAction = `toggleDateSelection('${dateStr}')`; } 
                    else { clickAction = (isBusy && bookingData) ? `openModal(${bookingData})` : `toggleDateSelection('${dateStr}')`; } 
                }
                
                grid.innerHTML += `<div onclick="${clickAction}" class="calendar-day ${cls} ${isSelected}"><span>${d}</span>${label ? `<span class="store-label">${label}</span>` : ''}</div>`;
            }
        }
        
        function openModal(b) {
            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('modal-date').innerText = b.requested_date;
            document.getElementById('modal-user').innerText = `${b.display_name} (${b.status})`;
            document.getElementById('modal-reason-user').innerText = b.reason_user || "Keine Angabe";
            
            const isAdmin = currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            const adminNoteField = document.getElementById('modal-reason-admin');
            const saveBtn = document.getElementById('btn-save-note');
            
            adminNoteField.value = b.reason_admin || "";
            
            if (isAdmin) {
                adminNoteField.readOnly = false;
                saveBtn.classList.remove('hidden');
                currentModalBookingId = b.id;
            } else {
                adminNoteField.readOnly = true;
                saveBtn.classList.add('hidden');
            }
        }

        async function saveAdminNote() {
            const note = document.getElementById('modal-reason-admin').value;
            setBtnLoading('btn-save-note', true, "");
            const { error } = await supabaseClient.from('bookings').update({ reason_admin: note }).eq('id', currentModalBookingId);
            setBtnLoading('btn-save-note', false);
            if (error) {
                showToast('‚ùå Fehler beim Speichern', 'error');
            } else {
                showToast('‚úÖ Notiz gespeichert', 'success');
                closeModal(); 
                fetchAndRender();
            }
        }

        // ============================================
        // DATE SELECTION & ACTION BAR
        // ============================================

        function toggleDateSelection(date) {
            if (selectedDates.includes(date)) { 
                selectedDates = selectedDates.filter(d => d !== date); 
            } else { 
                selectedDates.push(date); 
            }
            updateActionBar(); 
            supabaseClient.from('bookings').select('*').then(({data}) => { 
                renderCalendar('calendar-grid', data || [], false); 
                if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) { 
                    renderCalendar('admin-calendar-grid', data || [], true); 
                } 
            });
        }

        function updateActionBar() { 
            const bar = document.getElementById('action-bar'), count = selectedDates.length; 
            bar.classList.toggle('visible', count > 0); 
            
            // Bessere Info-Anzeige
            let infoText = `${count} ${count === 1 ? 'Tag' : 'Tage'} ausgew√§hlt`;
            if (count > 0 && count <= 3) {
                infoText += ': ' + selectedDates.join(', ');
            }
            document.getElementById('selection-info').innerText = infoText;
            
            document.getElementById('admin-actions').classList.toggle('hidden', currentUser.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()); 
        }

        function clearSelection() { 
            selectedDates = []; 
            updateActionBar(); 
            fetchAndRender(); 
        }

        function changeMonth(d) { 
            currentViewDate.setMonth(currentViewDate.getMonth() + d); 
            clearSelection(); 
        }

        // ============================================
        // USER ACTIONS
        // ============================================

        async function submitSelection() {
            if (selectedDates.length === 0) {
                showToast('‚ö†Ô∏è Keine Tage ausgew√§hlt', 'error');
                return;
            }

            showInput(
                'Anfrage senden',
                'Optionale Nachricht/Grund f√ºr die Anfrage:',
                'z.B. "Brauche einen Tag frei..."',
                async (reason) => {
                    if (reason === null) return; // Abgebrochen
                    
                    setBtnLoading('btn-submit', true, "Sende...");
                    
                    const ins = selectedDates.map(d => ({ 
                        user_id: currentUser.id, 
                        requested_date: d, 
                        display_name: userProfile.display_name, 
                        store_number: userProfile.store_number, 
                        user_email: currentUser.email, 
                        reason_user: reason, 
                        status: 'pending' 
                    }));
                    
                    const { error } = await supabaseClient.from('bookings').insert(ins);
                    
                    if (!error) { 
                        emailjs.init(EJS_PUBLIC_KEY); 
                        emailjs.send(EJS_SERVICE, EJS_ADMIN_TEMPLATE, { 
                            user_name: userProfile.display_name, 
                            store_number: userProfile.store_number, 
                            date: selectedDates.join(", "), 
                            reason: reason || "-" 
                        }); 
                        showToast('‚úÖ Anfrage erfolgreich gesendet!', 'success');
                        clearSelection(); 
                    } else {
                        showToast('‚ùå Fehler: ' + error.message, 'error');
                    }
                    
                    setBtnLoading('btn-submit', false);
                }
            );
        }

        // ============================================
        // ADMIN ACTIONS
        // ============================================

        async function submitAdminAction(type) {
            if (selectedDates.length === 0) {
                showToast('‚ö†Ô∏è Keine Tage ausgew√§hlt', 'error');
                return;
            }

            const insData = (status, store, display) => selectedDates.map(d => ({ 
                requested_date: d, 
                status, 
                store_number: store, 
                display_name: display, 
                user_id: currentUser.id, 
                user_email: currentUser.email 
            }));

            if (type === 'direkt') {
                showInput(
                    'Direkt buchen',
                    'Filiale eingeben:',
                    'z.B. 123',
                    async (filiale) => {
                        if (!filiale) return;
                        showConfirm(
                            `${selectedDates.length} Tage als GEBUCHT (Filiale ${filiale}) markieren?`,
                            async () => {
                                await supabaseClient.from('bookings').insert(insData('confirmed', filiale, 'Admin'));
                                showToast('‚úÖ Tage gebucht', 'success');
                                clearSelection();
                            }
                        );
                    }
                );
            } else if (type === 'urlaub') {
                showConfirm(
                    `${selectedDates.length} Tage als URLAUB markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('vacation', 'URLAUB', 'Admin'));
                        showToast('‚úÖ Urlaub eingetragen', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'krank') {
                showConfirm(
                    `${selectedDates.length} Tage als KRANK markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('sick', 'KRANK', 'Admin'));
                        showToast('‚úÖ Krankmeldung eingetragen', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'planned_free') {
                showConfirm(
                    `${selectedDates.length} Tage als GEPLANT FREI markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('planned_free', 'FREI', 'Admin'));
                        showToast('‚úÖ Geplant Frei eingetragen', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'frei') {
                showConfirm(
                    `${selectedDates.length} Tage FREIGEBEN (alle Buchungen l√∂schen)?`,
                    async () => {
                        await supabaseClient.from('bookings').delete().in('requested_date', selectedDates);
                        showToast('‚úÖ Tage freigegeben', 'success');
                        clearSelection();
                    }
                );
            }
        }

        async function renderUserApproval() {
            const list = document.getElementById('user-approval-list');
            const { data: users } = await supabaseClient.from('profiles').select('*').eq('is_approved', false);
            if (!users || users.length === 0) { 
                list.innerHTML = '<p class="text-[9px] text-zinc-600">Keine neuen User</p>'; 
                return; 
            }
            list.innerHTML = '';
            users.forEach(u => {
                list.innerHTML += `<div class="bg-white text-black p-3 rounded-xl flex justify-between items-center mb-2"><div class="text-left font-black text-[8px]">${u.display_name}<br><span class="font-normal">Filiale ${u.store_number}</span></div><button onclick="approveUser('${u.id}')" class="bg-blue-600 text-white px-3 py-2 rounded-lg font-black uppercase text-[7px]">OK</button></div>`;
            });
        }

        async function approveUser(uid) { 
            await supabaseClient.from('profiles').update({ is_approved: true }).eq('id', uid); 
            showToast('‚úÖ User freigeschaltet', 'success');
            fetchAndRender(); 
        }

        function renderLists(data) {
            const uL = document.getElementById('booking-list'), aL = document.getElementById('admin-list');
            uL.innerHTML = ''; 
            const pending = data.filter(x => x.status === 'pending');
            
            if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                aL.innerHTML = pending.length ? '' : '<p class="text-[9px] text-zinc-600">Keine Anfragen</p>';
                pending.forEach(b => {
                    aL.innerHTML += `<div class="bg-white text-black p-3 rounded-2xl flex justify-between items-center text-[8px] font-bold"><div>${b.requested_date}<br><span class="text-zinc-500">${b.display_name}</span></div><div class="flex gap-1"><button onclick="processRequest(this, '${b.id}','confirmed','${b.user_email}','${b.requested_date}')" class="bg-green-600 text-white px-3 py-2 rounded-lg">‚úì</button><button onclick="processRequest(this, '${b.id}','rejected','${b.user_email}','${b.requested_date}')" class="bg-red-600 text-white px-3 py-2 rounded-lg">X</button></div></div>`;
                });
            }
            
            const userBookings = data.filter(x => x.user_id === currentUser.id).sort((a,b) => b.requested_date.localeCompare(a.requested_date));
            if (userBookings.length === 0) {
                uL.innerHTML = '<p class="text-[9px] text-zinc-600">Noch keine Buchungen</p>';
            } else {
                userBookings.forEach(b => {
                    uL.innerHTML += `<div onclick='openModal(${JSON.stringify(b)})' class="p-4 bg-zinc-800/30 rounded-2xl flex justify-between items-center text-[9px] font-bold border border-zinc-800 cursor-pointer"><div>${b.requested_date}</div><div class="uppercase text-yellow-500">${b.status}</div></div>`;
                });
            }
        }

        async function processRequest(btn, id, status, email, date) {
            if (status === 'rejected') {
                showInput(
                    'Anfrage ablehnen',
                    'Ablehnungsgrund (optional):',
                    'z.B. "An diesem Tag bereits verplant..."',
                    async (reason) => {
                        btn.innerText = '..';
                        await supabaseClient.from('bookings').update({ status, reason_admin: reason }).eq('id', id);
                        
                        if (email) {
                            emailjs.init(EJS_PUBLIC_KEY);
                            const adminNote = reason ? `Grund: ${reason}` : '';
                            await emailjs.send(EJS_SERVICE, EJS_USER_TEMPLATE, { 
                                email: email, 
                                status_text: 'ABGELEHNT', 
                                date: date,
                                admin_note: adminNote
                            });
                        }
                        showToast('‚úÖ Anfrage abgelehnt', 'success');
                        fetchAndRender();
                    }
                );
            } else {
                // Best√§tigung
                btn.innerText = '..';
                await supabaseClient.from('bookings').update({ status }).eq('id', id);
                
                if (email) {
                    emailjs.init(EJS_PUBLIC_KEY);
                    await emailjs.send(EJS_SERVICE, EJS_USER_TEMPLATE, { 
                        email: email, 
                        status_text: 'BEST√ÑTIGT', 
                        date: date,
                        admin_note: ''
                    });
                }
                showToast('‚úÖ Anfrage best√§tigt', 'success');
                fetchAndRender();
            }
        }

        // ============================================
        // AUTH FUNCTIONS
        // ============================================

        async function handleAuthAction() {
            setBtnLoading('auth-btn-main', true, "...");
            const email = document.getElementById('email').value, password = document.getElementById('password').value;
            try {
                if (document.getElementById('signup-fields').classList.contains('hidden')) {
                    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) throw error; 
                    else location.reload();
                } else {
                    const name = document.getElementById('display_name').value;
                    const store = document.getElementById('store_number').value;
                    const code = document.getElementById('reg_code').value;
                    if (code.toUpperCase() !== MASTER_REG_CODE) throw new Error("Registrierungs-Code falsch");
                    const { error } = await supabaseClient.auth.signUp({ email, password, options: { data: { display_name: name, store_number: store } } });
                    if (error) throw error;
                    emailjs.init(EJS_PUBLIC_KEY);
                    await emailjs.send(EJS_SERVICE, EJS_ADMIN_TEMPLATE, { user_name: name, store_number: store, date: "NEUE ANMELDUNG", reason: "Wartet auf Freischaltung" });
                    showToast('‚úÖ Registriert! Warte auf Freischaltung.', 'success');
                    location.reload(); 
                }
            } catch (err) { 
                showToast('‚ùå ' + err.message, 'error');
                setBtnLoading('auth-btn-main', false); 
            }
        }

        function toggleAuthMode() { 
            const isHidden = document.getElementById('signup-fields').classList.toggle('hidden'); 
            document.getElementById('toggle-auth-btn').innerText = isHidden ? "Konto erstellen" : "Zum Login"; 
            document.getElementById('auth-btn-main').innerText = isHidden ? "Login" : "Registrieren"; 
        }

        async function handleLogout() { 
            await supabaseClient.auth.signOut(); 
            location.reload(); 
        }
    </script>
</body>
</html>
