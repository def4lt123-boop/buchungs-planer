<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#18181b">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/96/calendar--v1.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/96/calendar--v1.png">
    
    <title>Springerplan made by Flo - V4.1</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        .day-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.75rem; font-weight: bold; cursor: pointer; position: relative; transition: transform 0.1s ease; border: 2px solid transparent; touch-action: manipulation; min-height: 48px; }
        
        .day-free { background-color: #22c55e; color: white; } 
        .day-busy { background-color: #ef4444; color: white; } 
        .day-pending { background-color: #eab308; color: black; }
        .day-vacation { background-color: #3b82f6; color: white; }
        .day-sick { background-color: #7f1d1d; color: white; border: 1px solid #f87171; }
        .day-planned-free { background-color: #9333ea; color: white; }
        
        .day-disabled { background-color: #3f3f46 !important; color: #71717a !important; cursor: not-allowed !important; opacity: 0.5; pointer-events: none; }
        .day-selected { border: 3px solid #ffffff !important; transform: scale(0.92); z-index: 10; }
        .store-label { font-size: 0.45rem; background: rgba(0,0,0,0.4); width: 100%; text-align: center; position: absolute; bottom: 0; border-radius: 0 0 10px 10px; pointer-events: none; }
        
        .spinner { border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 2px solid white; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; margin-right: 6px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-loading { opacity: 0.7; cursor: wait !important; pointer-events: none; }

        #detail-modal, #confirm-modal, #input-modal { backdrop-filter: blur(5px); }
        
        #action-bar { 
            position: fixed; 
            bottom: calc(20px + env(safe-area-inset-bottom)); 
            left: 50%; 
            transform: translate(-50%, 200%); 
            z-index: 9999; 
            width: 92%; 
            max-width: 400px;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        #action-bar.visible { 
            transform: translate(-50%, 0); 
            opacity: 1;
            pointer-events: auto;
        }
        #app-container { padding-bottom: 120px !important; }
        
        * { user-select: none; -webkit-tap-highlight-color: transparent; }
        input, textarea { user-select: auto !important; }

        /* Legend Styles */
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.7rem; padding: 6px; }
        .legend-box { width: 18px; height: 18px; border-radius: 5px; flex-shrink: 0; }

        /* Toast Notification */
        .toast { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: #18181b; 
            color: white; 
            padding: 14px 22px; 
            border-radius: 14px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 10001;
            animation: slideIn 0.3s ease;
            border: 1px solid #3f3f46;
            font-size: 0.85rem;
        }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Offline Indicator */
        .offline-badge { 
            position: fixed; 
            top: 10px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #ef4444; 
            color: white; 
            padding: 8px 18px; 
            border-radius: 24px; 
            font-size: 0.7rem; 
            font-weight: bold; 
            z-index: 10002;
            animation: pulse 2s infinite;
        }

        /* Collapsible Booking List */
        .booking-item { 
            transition: opacity 0.3s ease, max-height 0.3s ease;
        }
        .booking-item.collapsed { 
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Refresh Button Animation */
        @keyframes rotate { 
            from { transform: rotate(0deg); } 
            to { transform: rotate(360deg); } 
        }
        .refresh-spinning {
            animation: rotate 0.6s linear;
        }

        /* Mobile-optimized inputs */
        input, textarea, select {
            font-size: 16px !important; /* Prevents zoom on iOS */
            min-height: 44px;
        }
        
        button {
            min-height: 44px; /* Better touch target */
        }

        /* Improved Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e1e1e 0%, #0a0a0a 100%);
        }
        
        .login-card {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 24px;
            padding: 32px 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
        }

        .login-input {
            background: #27272a;
            border: 2px solid #3f3f46;
            border-radius: 12px;
            padding: 14px 16px;
            width: 100%;
            color: white;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .login-input:focus {
            outline: none;
            border-color: #eab308;
        }

        .login-button {
            background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
            color: black;
            font-weight: 800;
            border-radius: 12px;
            padding: 16px;
            width: 100%;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: transform 0.1s, opacity 0.2s;
            min-height: 52px;
        }

        .login-button:active {
            transform: scale(0.98);
        }

        .toggle-button {
            color: #eab308;
            font-size: 14px;
            font-weight: 600;
            text-decoration: underline;
        }
    </style>
</head>
<body class="bg-black text-white font-sans overflow-x-hidden">
    
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-badge hidden">
        üî¥ Keine Internetverbindung
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="hidden fixed inset-0 z-[10000] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-zinc-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl border border-zinc-700 relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-zinc-500 font-bold text-2xl min-h-[44px] min-w-[44px]">‚úï</button>
            <h3 class="text-yellow-500 font-black uppercase text-xl mb-2">Details</h3>
            <p id="modal-date" class="text-sm text-zinc-400 font-bold mb-4">DATUM</p>
            
            <div class="space-y-4">
                <div class="bg-zinc-900 p-4 rounded-xl border border-zinc-700">
                    <p class="text-[10px] text-zinc-500 uppercase font-bold mb-2">Gebucht von / Status</p>
                    <p id="modal-user" class="text-base font-bold text-white">...</p>
                </div>

                <div class="bg-zinc-900 p-4 rounded-xl border border-zinc-700">
                    <p class="text-[10px] text-zinc-500 uppercase font-bold mb-2">Buchungsgrund (optional)</p>
                    <p id="modal-reason-user" class="text-sm text-white italic">Keine Info</p>
                </div>

                <div id="admin-note-area" class="bg-zinc-900 p-4 rounded-xl border border-zinc-700">
                    <p class="text-[10px] text-zinc-500 uppercase font-bold mb-2">Anmerkung</p>
                    <textarea id="modal-reason-admin" class="w-full bg-zinc-800 text-white text-sm p-3 rounded-lg outline-none border-2 border-zinc-700 focus:border-yellow-500" rows="2" placeholder="Noch keine Anmerkung vorhanden..."></textarea>
                    <button id="btn-save-note" onclick="saveAdminNote()" class="hidden w-full mt-3 bg-yellow-500 text-black text-xs font-black py-3 rounded-lg uppercase min-h-[44px]">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-[10000] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-zinc-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl border border-zinc-700">
            <h3 class="text-yellow-500 font-black uppercase text-xl mb-3">Best√§tigung</h3>
            <p id="confirm-message" class="text-base text-zinc-300 mb-6"></p>
            <div class="flex gap-3">
                <button onclick="cancelConfirm()" class="flex-1 bg-zinc-700 text-white py-4 rounded-xl font-bold text-base min-h-[52px]">Abbrechen</button>
                <button id="confirm-yes-btn" onclick="confirmAction()" class="flex-1 bg-yellow-500 text-black py-4 rounded-xl font-bold text-base min-h-[52px]">Best√§tigen</button>
            </div>
        </div>
    </div>

    <!-- Input Modal (replaces prompt()) -->
    <div id="input-modal" class="hidden fixed inset-0 z-[10000] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-zinc-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl border border-zinc-700">
            <h3 id="input-modal-title" class="text-yellow-500 font-black uppercase text-xl mb-3">Eingabe</h3>
            <p id="input-modal-label" class="text-sm text-zinc-300 mb-3"></p>
            <textarea id="input-modal-textarea" class="w-full bg-zinc-900 text-white p-4 rounded-xl outline-none border-2 border-zinc-700 focus:border-yellow-500 text-base" rows="3" placeholder=""></textarea>
            <div class="flex gap-3 mt-4">
                <button onclick="cancelInput()" class="flex-1 bg-zinc-700 text-white py-4 rounded-xl font-bold text-base min-h-[52px]">Abbrechen</button>
                <button id="input-ok-btn" onclick="submitInput()" class="flex-1 bg-yellow-500 text-black py-4 rounded-xl font-bold text-base min-h-[52px]">OK</button>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="hidden login-container">
        <div class="login-card">
            <div class="text-center mb-8">
                <div class="text-5xl mb-4">üìÖ</div>
                <h1 class="text-3xl font-black text-yellow-500 mb-2">Springerplan</h1>
                <p class="text-sm text-zinc-400">made by Flo v4.1</p>
            </div>
            
            <div class="space-y-4">
                <input type="email" id="email" placeholder="E-Mail" class="login-input" autocomplete="email">
                <input type="password" id="password" placeholder="Passwort" class="login-input" autocomplete="current-password">
                
                <div id="signup-fields" class="hidden space-y-4">
                    <input type="text" id="display_name" placeholder="Dein Name" class="login-input" autocomplete="name">
                    <input type="text" id="store_number" placeholder="Filial-Nummer" class="login-input">
                    <input type="text" id="reg_code" placeholder="Registrierungs-Code" class="login-input">
                </div>
                
                <button id="auth-btn-main" onclick="handleAuthAction()" class="login-button">
                    Login
                </button>
                
                <div class="text-center mt-6">
                    <button id="toggle-auth-btn" onclick="toggleAuthMode()" class="toggle-button">
                        Konto erstellen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-container" class="hidden max-w-md mx-auto p-4 pb-32">
        
        <!-- Header with Logout -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-black text-yellow-500">Springerplan</h1>
                <p id="user-display" class="text-xs text-zinc-500"></p>
            </div>
            <button onclick="handleLogout()" class="bg-red-600 px-4 py-2 rounded-xl text-sm font-bold min-h-[44px]">Logout</button>
        </div>

        <!-- Admin Section: User Approvals -->
        <div id="admin-approval-section" class="hidden mb-6 bg-zinc-900 p-5 rounded-2xl border border-zinc-800">
            <h2 class="text-yellow-500 font-black uppercase text-sm mb-3">üë§ User-Freischaltung</h2>
            <div id="user-approval-list"></div>
        </div>

        <!-- Booking List -->
        <div class="mb-6 bg-zinc-900 p-5 rounded-2xl border border-zinc-800">
            <h2 class="text-yellow-500 font-black uppercase text-sm mb-3">üìã Deine Buchungen</h2>
            <div id="booking-list"></div>
            <button id="show-more-bookings" onclick="toggleBookingList()" class="hidden w-full mt-3 text-yellow-500 font-bold text-sm py-2 min-h-[44px]">
                ‚ñº Mehr anzeigen
            </button>
        </div>

        <!-- Admin Section: Pending Requests -->
        <div id="admin-section" class="hidden mb-6 bg-zinc-900 p-5 rounded-2xl border border-zinc-800">
            <h2 class="text-yellow-500 font-black uppercase text-sm mb-3">‚è≥ Anfragen</h2>
            <div id="admin-list"></div>
        </div>

        <!-- Refresh Button -->
        <div class="flex justify-center mb-3">
            <button onclick="refreshCalendar()" class="bg-yellow-500 text-black px-6 py-3 rounded-xl font-bold text-sm flex items-center gap-2 min-h-[48px]">
                <span id="refresh-icon">üîÑ</span>
                Kalender aktualisieren
            </button>
        </div>

        <!-- Calendar -->
        <div class="bg-zinc-900 p-5 rounded-2xl border border-zinc-800 mb-6">
            <div class="flex justify-between items-center mb-4">
                <button onclick="prevMonth()" class="bg-zinc-800 px-4 py-2 rounded-xl font-bold text-lg min-h-[44px] min-w-[44px]">‚óÄ</button>
                <h2 id="month-year" class="text-lg font-black text-white"></h2>
                <button onclick="nextMonth()" class="bg-zinc-800 px-4 py-2 rounded-xl font-bold text-lg min-h-[44px] min-w-[44px]">‚ñ∂</button>
            </div>
            
            <div class="day-grid text-[9px] text-zinc-500 font-bold uppercase mb-2">
                <div class="text-center">Mo</div><div class="text-center">Di</div><div class="text-center">Mi</div><div class="text-center">Do</div><div class="text-center">Fr</div><div class="text-center">Sa</div><div class="text-center">So</div>
            </div>
            
            <div id="calendar-days" class="day-grid"></div>
        </div>

        <!-- Legend -->
        <div class="bg-zinc-900 p-5 rounded-2xl border border-zinc-800 mb-6">
            <h3 class="text-yellow-500 font-black uppercase text-xs mb-3">Legende</h3>
            <div class="grid grid-cols-2 gap-2">
                <div class="legend-item"><div class="legend-box day-free"></div><span>Frei</span></div>
                <div class="legend-item"><div class="legend-box day-busy"></div><span>Belegt</span></div>
                <div class="legend-item"><div class="legend-box day-pending"></div><span>Anfrage</span></div>
                <div class="legend-item"><div class="legend-box day-vacation"></div><span>Urlaub</span></div>
                <div class="legend-item"><div class="legend-box day-sick"></div><span>Krank</span></div>
                <div class="legend-item"><div class="legend-box day-planned-free"></div><span>Geplant Frei</span></div>
            </div>
        </div>
    </div>

    <!-- ACTION BAR -->
    <div id="action-bar" class="bg-zinc-900 rounded-3xl shadow-2xl border-2 border-yellow-500/50 p-4">
        <p class="text-center text-yellow-500 font-black text-xs uppercase mb-3"><span id="selected-count">0</span> Tage ausgew√§hlt</p>
        <div class="grid grid-cols-2 gap-2 mb-3">
            <button onclick="bookSelected()" class="bg-yellow-500 text-black py-3 rounded-xl font-bold text-xs uppercase min-h-[48px]">Buchen</button>
            <button onclick="clearSelection()" class="bg-zinc-700 text-white py-3 rounded-xl font-bold text-xs uppercase min-h-[48px]">Abbrechen</button>
        </div>
        <div id="admin-actions" class="hidden grid grid-cols-3 gap-2">
            <button onclick="adminAction('urlaub')" class="bg-blue-600 text-white py-3 rounded-xl font-bold text-[10px] uppercase min-h-[48px]">Urlaub</button>
            <button onclick="adminAction('krank')" class="bg-red-900 text-white py-3 rounded-xl font-bold text-[10px] uppercase min-h-[48px]">Krank</button>
            <button onclick="adminAction('geplant')" class="bg-purple-600 text-white py-3 rounded-xl font-bold text-[10px] uppercase min-h-[48px]">Geplant</button>
            <button onclick="adminAction('belegt')" class="bg-red-600 text-white py-3 rounded-xl font-bold text-[10px] uppercase min-h-[48px] col-span-2">Belegt</button>
            <button onclick="adminAction('frei')" class="bg-green-600 text-white py-3 rounded-xl font-bold text-[10px] uppercase min-h-[48px]">Freigeben</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bskqsqoznyyrjfawedos.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJza3FzcW96bnl5cmpmd';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const ADMIN_EMAIL = 'florian.hofmann-k@hotmail.com';
        const MASTER_REG_CODE = "FLORENTINA2025";
        
        const EJS_PUBLIC_KEY = "mUd3CxPpfAQJ1FgYz";
        const EJS_SERVICE = "service_g3w7snn";
        const EJS_USER_TEMPLATE = "template_6bqjgex";
        const EJS_ADMIN_TEMPLATE = "template_xu3cqkc";

        let currentUser = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let allBookings = [];
        let selectedDates = [];
        let confirmCallback = null;
        let inputCallback = null;

        // Booking list collapse state
        let bookingListExpanded = false;
        const MAX_VISIBLE_BOOKINGS = 5;

        // ============================================
        // INITIALIZATION
        // ============================================

        window.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                document.getElementById('login-screen').classList.remove('hidden');
            } else {
                currentUser = session.user;
                const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
                
                if (profile && !profile.is_approved) {
                    showToast('‚è≥ Dein Account wartet noch auf Freischaltung', 'info');
                    await supabaseClient.auth.signOut();
                    document.getElementById('login-screen').classList.remove('hidden');
                } else {
                    currentUser.display_name = profile?.display_name || currentUser.email;
                    currentUser.store_number = profile?.store_number || '';
                    document.getElementById('app-container').classList.remove('hidden');
                    document.getElementById('user-display').innerText = `${currentUser.display_name} (Filiale ${currentUser.store_number})`;
                    
                    if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                        document.getElementById('admin-section').classList.remove('hidden');
                        document.getElementById('admin-approval-section').classList.remove('hidden');
                        document.getElementById('admin-actions').classList.remove('hidden');
                        renderUserApproval();
                    }
                    
                    fetchAndRender();
                    setupRealtimeSubscription();
                }
            }

            window.addEventListener('online', () => document.getElementById('offline-indicator').classList.add('hidden'));
            window.addEventListener('offline', () => document.getElementById('offline-indicator').classList.remove('hidden'));
        });

        function setupRealtimeSubscription() {
            supabaseClient.channel('bookings-channel').on('postgres_changes', { event: '*', schema: 'public', table: 'bookings' }, fetchAndRender).subscribe();
        }

        async function fetchAndRender() {
            const { data } = await supabaseClient.from('bookings').select('*');
            allBookings = data || [];
            renderCalendar();
            renderLists(allBookings);
            if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) renderUserApproval();
        }

        // ============================================
        // REFRESH CALENDAR
        // ============================================
        
        function refreshCalendar() {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('refresh-spinning');
            
            fetchAndRender();
            
            setTimeout(() => {
                icon.classList.remove('refresh-spinning');
                showToast('‚úÖ Kalender aktualisiert', 'success');
            }, 600);
        }

        // ============================================
        // BOOKING LIST COLLAPSE/EXPAND
        // ============================================

        function toggleBookingList() {
            bookingListExpanded = !bookingListExpanded;
            const button = document.getElementById('show-more-bookings');
            const items = document.querySelectorAll('.booking-item');
            
            if (bookingListExpanded) {
                items.forEach(item => item.classList.remove('collapsed'));
                button.innerHTML = '‚ñ≤ Weniger anzeigen';
            } else {
                items.forEach((item, index) => {
                    if (index >= MAX_VISIBLE_BOOKINGS) {
                        item.classList.add('collapsed');
                    }
                });
                button.innerHTML = '‚ñº Mehr anzeigen';
            }
        }

        // ============================================
        // CALENDAR RENDERING
        // ============================================

        function renderCalendar() {
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startOffset = (firstDay.getDay() + 6) % 7;
            
            const monthNames = ["Januar", "Februar", "M√§rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
            document.getElementById('month-year').innerText = `${monthNames[currentMonth]} ${currentYear}`;
            
            const container = document.getElementById('calendar-days');
            container.innerHTML = '';
            
            for (let i = 0; i < startOffset; i++) container.innerHTML += '<div></div>';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayBookings = allBookings.filter(b => b.requested_date === dateStr);
                const dateObj = new Date(currentYear, currentMonth, day);
                
                let classes = 'calendar-day ';
                let storeLabels = '';
                
                if (dateObj < today) {
                    classes += 'day-disabled';
                } else if (dayBookings.length === 0) {
                    classes += 'day-free';
                } else {
                    const statuses = dayBookings.map(b => b.status);
                    if (statuses.includes('confirmed')) {
                        classes += 'day-busy';
                        const stores = [...new Set(dayBookings.filter(b => b.status === 'confirmed').map(b => b.store_number))];
                        storeLabels = stores.map(s => `<div class="store-label">F${s}</div>`).join('');
                    } else if (statuses.includes('pending')) {
                        classes += 'day-pending';
                    } else if (statuses.includes('vacation')) {
                        classes += 'day-vacation';
                    } else if (statuses.includes('sick')) {
                        classes += 'day-sick';
                    } else if (statuses.includes('planned_free')) {
                        classes += 'day-planned-free';
                    }
                }
                
                if (selectedDates.includes(dateStr)) classes += ' day-selected';
                
                container.innerHTML += `<div class="${classes}" data-date="${dateStr}" onclick="handleDayClick('${dateStr}')"><div>${day}</div>${storeLabels}</div>`;
            }
        }

        function prevMonth() { if (currentMonth === 0) { currentMonth = 11; currentYear--; } else currentMonth--; renderCalendar(); }
        function nextMonth() { if (currentMonth === 11) { currentMonth = 0; currentYear++; } else currentMonth++; renderCalendar(); }

        function handleDayClick(dateStr) {
            const dateObj = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (dateObj < today) return;

            const dayBookings = allBookings.filter(b => b.requested_date === dateStr);
            
            if (dayBookings.length > 0) {
                openModal(dayBookings[0]);
            } else {
                if (selectedDates.includes(dateStr)) {
                    selectedDates = selectedDates.filter(d => d !== dateStr);
                } else {
                    selectedDates.push(dateStr);
                }
                updateActionBar();
                renderCalendar();
            }
        }

        function clearSelection() {
            selectedDates = [];
            updateActionBar();
            renderCalendar();
        }

        function updateActionBar() {
            const bar = document.getElementById('action-bar');
            const count = document.getElementById('selected-count');
            count.innerText = selectedDates.length;
            
            if (selectedDates.length > 0) {
                bar.classList.add('visible');
            } else {
                bar.classList.remove('visible');
            }
        }

        // ============================================
        // BOOKING ACTIONS
        // ============================================

        async function bookSelected() {
            if (selectedDates.length === 0) return;
            
            showInput(
                'Buchung erstellen',
                'Grund f√ºr die Buchung (optional):',
                'z.B. "Familienfeier", "Arzttermin"...',
                async (reason) => {
                    const bookings = selectedDates.map(date => ({
                        user_id: currentUser.id,
                        user_email: currentUser.email,
                        display_name: currentUser.display_name,
                        store_number: currentUser.store_number,
                        requested_date: date,
                        status: 'pending',
                        reason_user: reason || null
                    }));
                    
                    await supabaseClient.from('bookings').insert(bookings);
                    
                    emailjs.init(EJS_PUBLIC_KEY);
                    await emailjs.send(EJS_SERVICE, EJS_ADMIN_TEMPLATE, {
                        user_name: currentUser.display_name,
                        store_number: currentUser.store_number,
                        date: selectedDates.join(', '),
                        reason: reason || 'Kein Grund angegeben'
                    });
                    
                    showToast('‚úÖ Buchung eingereicht', 'success');
                    clearSelection();
                }
            );
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================

        function openModal(booking) {
            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('modal-date').innerText = new Date(booking.requested_date + 'T00:00:00').toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            let statusText = booking.status.toUpperCase();
            if (booking.status === 'confirmed') statusText = 'BEST√ÑTIGT';
            else if (booking.status === 'pending') statusText = 'AUSSTEHEND';
            else if (booking.status === 'rejected') statusText = 'ABGELEHNT';
            else if (booking.status === 'vacation') statusText = 'URLAUB';
            else if (booking.status === 'sick') statusText = 'KRANK';
            else if (booking.status === 'planned_free') statusText = 'GEPLANT FREI';
            
            document.getElementById('modal-user').innerText = `${booking.display_name || 'Unbekannt'} (${statusText})`;
            document.getElementById('modal-reason-user').innerText = booking.reason_user || 'Keine Info';
            document.getElementById('modal-reason-admin').value = booking.reason_admin || '';
            
            if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                document.getElementById('admin-note-area').classList.remove('hidden');
                const saveBtn = document.getElementById('btn-save-note');
                saveBtn.classList.remove('hidden');
                saveBtn.onclick = () => saveAdminNote(booking.id);
            } else {
                document.getElementById('admin-note-area').classList.add('hidden');
            }
            
            window.currentModalBooking = booking;
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        async function saveAdminNote(bookingId = null) {
            const note = document.getElementById('modal-reason-admin').value;
            const id = bookingId || window.currentModalBooking.id;
            await supabaseClient.from('bookings').update({ reason_admin: note }).eq('id', id);
            showToast('‚úÖ Anmerkung gespeichert', 'success');
            closeModal();
            fetchAndRender();
        }

        // ============================================
        // CONFIRM MODAL
        // ============================================

        function showConfirm(message, callback) {
            document.getElementById('confirm-message').innerText = message;
            document.getElementById('confirm-modal').classList.remove('hidden');
            confirmCallback = callback;
        }

        function cancelConfirm() {
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmCallback = null;
        }

        async function confirmAction() {
            document.getElementById('confirm-modal').classList.add('hidden');
            if (confirmCallback) {
                await confirmCallback();
                confirmCallback = null;
            }
        }

        // ============================================
        // INPUT MODAL
        // ============================================

        function showInput(title, label, placeholder, callback) {
            document.getElementById('input-modal-title').innerText = title;
            document.getElementById('input-modal-label').innerText = label;
            document.getElementById('input-modal-textarea').placeholder = placeholder;
            document.getElementById('input-modal-textarea').value = '';
            document.getElementById('input-modal').classList.remove('hidden');
            inputCallback = callback;
        }

        function cancelInput() {
            document.getElementById('input-modal').classList.add('hidden');
            inputCallback = null;
        }

        async function submitInput() {
            const value = document.getElementById('input-modal-textarea').value;
            document.getElementById('input-modal').classList.add('hidden');
            if (inputCallback) {
                await inputCallback(value);
                inputCallback = null;
            }
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============================================
        // ADMIN ACTIONS
        // ============================================

        function setBtnLoading(btnId, loading, text = '') {
            const btn = document.getElementById(btnId);
            if (loading) {
                btn.classList.add('btn-loading');
                btn.innerHTML = `<span class="spinner"></span>${text}`;
            } else {
                btn.classList.remove('btn-loading');
                btn.innerHTML = text;
            }
        }

        function adminAction(type) {
            if (selectedDates.length === 0) return;
            
            const insData = (status, reason, name) => selectedDates.map(d => ({
                user_id: currentUser.id,
                user_email: currentUser.email,
                display_name: name,
                store_number: currentUser.store_number,
                requested_date: d,
                status: status,
                reason_admin: reason
            }));

            if (type === 'urlaub') {
                showConfirm(
                    `${selectedDates.length} Tage als URLAUB markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('vacation', 'Urlaub', 'Admin'));
                        showToast('‚úÖ Urlaub eingetragen', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'krank') {
                showConfirm(
                    `${selectedDates.length} Tage als KRANK markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('sick', 'Krank', 'Admin'));
                        showToast('‚úÖ Krankmeldung eingetragen', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'belegt') {
                showInput(
                    'Tag(e) belegen',
                    'Filial-Nummer:',
                    'z.B. "42"',
                    async (store) => {
                        await supabaseClient.from('bookings').insert(insData('confirmed', `Belegt durch Admin (Filiale ${store})`, `Filiale ${store}`));
                        showToast('‚úÖ Tag(e) als belegt markiert', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'geplant') {
                showConfirm(
                    `${selectedDates.length} Tage als GEPLANT FREI markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('planned_free', 'FREI', 'Admin'));
                        showToast('‚úÖ Geplant Frei eingetragen', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'frei') {
                showConfirm(
                    `${selectedDates.length} Tage FREIGEBEN (alle Buchungen l√∂schen)?`,
                    async () => {
                        await supabaseClient.from('bookings').delete().in('requested_date', selectedDates);
                        showToast('‚úÖ Tage freigegeben', 'success');
                        clearSelection();
                    }
                );
            }
        }

        async function renderUserApproval() {
            const list = document.getElementById('user-approval-list');
            const { data: users } = await supabaseClient.from('profiles').select('*').eq('is_approved', false);
            if (!users || users.length === 0) { 
                list.innerHTML = '<p class="text-xs text-zinc-600">Keine neuen User</p>'; 
                return; 
            }
            list.innerHTML = '';
            users.forEach(u => {
                list.innerHTML += `<div class="bg-white text-black p-4 rounded-xl flex justify-between items-center mb-3"><div class="text-left font-black text-sm">${u.display_name}<br><span class="font-normal text-xs">Filiale ${u.store_number}</span></div><button onclick="approveUser('${u.id}')" class="bg-blue-600 text-white px-4 py-3 rounded-lg font-black uppercase text-xs min-h-[44px]">OK</button></div>`;
            });
        }

        async function approveUser(uid) { 
            await supabaseClient.from('profiles').update({ is_approved: true }).eq('id', uid); 
            showToast('‚úÖ User freigeschaltet', 'success');
            fetchAndRender(); 
        }

        function renderLists(data) {
            const uL = document.getElementById('booking-list'), aL = document.getElementById('admin-list');
            uL.innerHTML = ''; 
            const pending = data.filter(x => x.status === 'pending');
            
            if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                aL.innerHTML = pending.length ? '' : '<p class="text-xs text-zinc-600">Keine Anfragen</p>';
                pending.forEach(b => {
                    aL.innerHTML += `<div class="bg-white text-black p-4 rounded-2xl flex justify-between items-center text-sm font-bold mb-3"><div>${b.requested_date}<br><span class="text-zinc-500 text-xs">${b.display_name}</span></div><div class="flex gap-2"><button onclick="processRequest(this, '${b.id}','confirmed','${b.user_email}','${b.requested_date}')" class="bg-green-600 text-white px-4 py-3 rounded-lg min-h-[44px] min-w-[44px]">‚úì</button><button onclick="processRequest(this, '${b.id}','rejected','${b.user_email}','${b.requested_date}')" class="bg-red-600 text-white px-4 py-3 rounded-lg min-h-[44px] min-w-[44px]">X</button></div></div>`;
                });
            }
            
            const userBookings = data.filter(x => x.user_id === currentUser.id).sort((a,b) => b.requested_date.localeCompare(a.requested_date));
            if (userBookings.length === 0) {
                uL.innerHTML = '<p class="text-xs text-zinc-600">Noch keine Buchungen</p>';
                document.getElementById('show-more-bookings').classList.add('hidden');
            } else {
                userBookings.forEach((b, index) => {
                    const isCollapsed = index >= MAX_VISIBLE_BOOKINGS && !bookingListExpanded;
                    const collapsedClass = isCollapsed ? 'collapsed' : '';
                    uL.innerHTML += `<div onclick='openModal(${JSON.stringify(b)})' class="booking-item ${collapsedClass} p-4 bg-zinc-800/30 rounded-2xl flex justify-between items-center text-sm font-bold border border-zinc-800 cursor-pointer mb-3"><div>${b.requested_date}</div><div class="uppercase text-yellow-500 text-xs">${b.status}</div></div>`;
                });
                
                if (userBookings.length > MAX_VISIBLE_BOOKINGS) {
                    document.getElementById('show-more-bookings').classList.remove('hidden');
                    document.getElementById('show-more-bookings').innerHTML = bookingListExpanded ? '‚ñ≤ Weniger anzeigen' : '‚ñº Mehr anzeigen';
                } else {
                    document.getElementById('show-more-bookings').classList.add('hidden');
                }
            }
        }

        async function processRequest(btn, id, status, email, date) {
            if (status === 'rejected') {
                showInput(
                    'Anfrage ablehnen',
                    'Ablehnungsgrund (optional):',
                    'z.B. "An diesem Tag bereits verplant..."',
                    async (reason) => {
                        btn.innerText = '..';
                        await supabaseClient.from('bookings').update({ status, reason_admin: reason }).eq('id', id);
                        
                        if (email) {
                            emailjs.init(EJS_PUBLIC_KEY);
                            const adminNote = reason ? `Grund: ${reason}` : '';
                            await emailjs.send(EJS_SERVICE, EJS_USER_TEMPLATE, { 
                                email: email, 
                                status_text: 'ABGELEHNT', 
                                date: date,
                                admin_note: adminNote
                            });
                        }
                        showToast('‚úÖ Anfrage abgelehnt', 'success');
                        fetchAndRender();
                    }
                );
            } else {
                // Best√§tigung
                btn.innerText = '..';
                await supabaseClient.from('bookings').update({ status }).eq('id', id);
                
                if (email) {
                    emailjs.init(EJS_PUBLIC_KEY);
                    await emailjs.send(EJS_SERVICE, EJS_USER_TEMPLATE, { 
                        email: email, 
                        status_text: 'BEST√ÑTIGT', 
                        date: date,
                        admin_note: ''
                    });
                }
                showToast('‚úÖ Anfrage best√§tigt', 'success');
                fetchAndRender();
            }
        }

        // ============================================
        // AUTH FUNCTIONS
        // ============================================

        async function handleAuthAction() {
            setBtnLoading('auth-btn-main', true, "...");
            const email = document.getElementById('email').value, password = document.getElementById('password').value;
            try {
                if (document.getElementById('signup-fields').classList.contains('hidden')) {
                    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) throw error; 
                    else location.reload();
                } else {
                    const name = document.getElementById('display_name').value;
                    const store = document.getElementById('store_number').value;
                    const code = document.getElementById('reg_code').value;
                    if (code.toUpperCase() !== MASTER_REG_CODE) throw new Error("Registrierungs-Code falsch");
                    const { error } = await supabaseClient.auth.signUp({ email, password, options: { data: { display_name: name, store_number: store } } });
                    if (error) throw error;
                    emailjs.init(EJS_PUBLIC_KEY);
                    await emailjs.send(EJS_SERVICE, EJS_ADMIN_TEMPLATE, { user_name: name, store_number: store, date: "NEUE ANMELDUNG", reason: "Wartet auf Freischaltung" });
                    showToast('‚úÖ Registriert! Warte auf Freischaltung.', 'success');
                    location.reload(); 
                }
            } catch (err) { 
                showToast('‚ùå ' + err.message, 'error');
                setBtnLoading('auth-btn-main', false, document.getElementById('signup-fields').classList.contains('hidden') ? 'Login' : 'Registrieren'); 
            }
        }

        function toggleAuthMode() { 
            const isHidden = document.getElementById('signup-fields').classList.toggle('hidden'); 
            document.getElementById('toggle-auth-btn').innerText = isHidden ? "Konto erstellen" : "Zum Login"; 
            document.getElementById('auth-btn-main').innerText = isHidden ? "Login" : "Registrieren"; 
        }

        async function handleLogout() { 
            await supabaseClient.auth.signOut(); 
            location.reload(); 
        }
    </script>
</body>
</html>
