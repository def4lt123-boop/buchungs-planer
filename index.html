<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#18181b">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/96/calendar--v1.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/96/calendar--v1.png">
    
    <title>Springerplan made by Flo - V4.0 Mobile</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        /* === KALENDER - Mobile-Optimiert === */
        .day-grid { 
            display: grid; 
            grid-template-columns: repeat(6, 1fr); /* 6 Tage: Mo-Sa */
            gap: 6px; /* Mehr Abstand f√ºr bessere Touch-Targets */
        }
        
        .calendar-day { 
            aspect-ratio: 1/1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            border-radius: 14px; /* Rundere Ecken */
            font-size: 0.85rem; /* Gr√∂√üere Schrift */
            font-weight: bold; 
            cursor: pointer; 
            position: relative; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); /* Smooth Animation */
            border: 2px solid transparent; 
            touch-action: manipulation;
            min-height: 48px; /* Mindestgr√∂√üe f√ºr Touch (Apple HIG: 44px) */
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); /* Schatten f√ºr Tiefe */
        }
        
        .calendar-day:active {
            transform: scale(0.95); /* Feedback beim Antippen */
        }
        
        /* === STATUS-FARBEN mit Gradienten === */
        .day-free { 
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
            color: white; 
        } 
        .day-busy { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            color: white; 
        } 
        .day-pending { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
            color: white; /* Besser lesbar */
            font-weight: 900;
        }
        .day-vacation { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
            color: white; 
        }
        .day-sick { 
            background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%); 
            color: white; 
            border: 2px solid #fca5a5; 
        }
        .day-planned-free { 
            background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); 
            color: white; 
        }
        
        .day-disabled { 
            background: linear-gradient(135deg, #27272a 0%, #18181b 100%) !important;
            color: #71717a !important; 
            cursor: not-allowed !important; 
            opacity: 0.6; 
            pointer-events: none; 
            box-shadow: none !important;
            border: 1px solid #3f3f46 !important;
        }
        
        .day-selected { 
            border: 3px solid #fbbf24 !important; /* Gold-Border */
            transform: scale(1.05); 
            z-index: 10; 
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5); /* Glow-Effekt */
        }
        
        .store-label { 
            font-size: 0.5rem; /* Gr√∂√üer */
            background: rgba(0,0,0,0.6); 
            width: 100%; 
            text-align: center; 
            position: absolute; 
            bottom: 0; 
            border-radius: 0 0 12px 12px; 
            pointer-events: none; 
            padding: 2px 0;
            letter-spacing: 0.5px;
        }
        
        /* === LOADING & ANIMATIONS === */
        .spinner { 
            border: 3px solid rgba(255,255,255,0.2); 
            border-radius: 50%; 
            border-top: 3px solid #fbbf24; 
            width: 16px; 
            height: 16px; 
            animation: spin 0.8s linear infinite; 
            display: inline-block; 
            margin-right: 8px; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .btn-loading { 
            opacity: 0.6; 
            cursor: wait !important; 
            pointer-events: none; 
        }

        /* === MODALS mit Backdrop Blur === */
        #detail-modal, #confirm-modal, #input-modal { 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
        }
        
        /* === ACTION BAR - Mobile-Optimiert === */
        #action-bar { 
            position: fixed; 
            bottom: max(20px, env(safe-area-inset-bottom)); /* iPhone-Notch safe */
            left: 50%; 
            transform: translate(-50%, 120%); 
            z-index: 9999; 
            width: 94%; 
            max-width: 420px;
            transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        opacity 0.3s ease,
                        box-shadow 0.3s ease;
            opacity: 0;
            pointer-events: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6); /* St√§rkerer Schatten */
        }
        
        #action-bar.visible { 
            transform: translate(-50%, 0); 
            opacity: 1;
            pointer-events: auto;
            box-shadow: 0 25px 70px rgba(0,0,0,0.7), 0 0 30px rgba(251, 191, 36, 0.3); /* Glow */
        }
        
        #app-container { 
            padding-bottom: max(140px, calc(120px + env(safe-area-inset-bottom))) !important; 
        }
        
        /* === TOUCH-OPTIMIERUNG === */
        * { 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        input, textarea { 
            user-select: auto !important; 
            font-size: 16px !important; /* Verhindert Zoom auf iOS */
        }

        /* === LEGEND === */
        .legend-item { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 0.7rem; 
            padding: 4px 0;
        }
        
        .legend-box { 
            width: 20px; 
            height: 20px; 
            border-radius: 6px; 
            flex-shrink: 0; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        /* === TOAST NOTIFICATION === */
        .toast { 
            position: fixed; 
            top: max(20px, env(safe-area-inset-top)); 
            right: 16px;
            left: 16px;
            max-width: 400px;
            margin: 0 auto;
            background: linear-gradient(135deg, #18181b 0%, #27272a 100%); 
            color: white; 
            padding: 14px 18px; 
            border-radius: 16px; 
            box-shadow: 0 12px 40px rgba(0,0,0,0.6), 0 0 20px rgba(251, 191, 36, 0.2);
            z-index: 10001;
            animation: slideInDown 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid #3f3f46;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        @keyframes slideInDown { 
            from { 
                transform: translateY(-100px); 
                opacity: 0; 
            } 
            to { 
                transform: translateY(0); 
                opacity: 1; 
            } 
        }

        /* === OFFLINE INDICATOR === */
        .offline-badge { 
            position: fixed; 
            top: max(12px, env(safe-area-inset-top)); 
            left: 50%; 
            transform: translateX(-50%); 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            color: white; 
            padding: 8px 18px; 
            border-radius: 24px; 
            font-size: 0.7rem; 
            font-weight: 800; 
            z-index: 10002;
            animation: pulse 2s infinite;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.5);
            letter-spacing: 0.5px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* === BUTTONS - Modernere Styles === */
        button {
            transition: all 0.2s ease;
            font-weight: 700;
        }
        
        button:active {
            transform: scale(0.96);
        }

        /* === CARDS mit Schatten === */
        .bg-zinc-800 {
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }
        
        .rounded-3xl {
            border-radius: 24px;
        }
        
        .rounded-2xl {
            border-radius: 20px;
        }

        /* === RESPONSIVE TYPOGRAPHY === */
        @media (max-width: 360px) {
            .calendar-day {
                font-size: 0.75rem;
                min-height: 44px;
            }
            
            .store-label {
                font-size: 0.45rem;
            }
        }
        
        @media (min-width: 400px) {
            .calendar-day {
                font-size: 0.95rem;
                min-height: 52px;
            }
        }

        /* === STATUS BANNER mit Gradient === */
        #status-banner {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #fbbf24 !important;
            box-shadow: 0 8px 24px rgba(251, 191, 36, 0.3);
        }

        /* === ADMIN PANEL HIGHLIGHTS === */
        .bg-red-900\/20 {
            background: linear-gradient(135deg, rgba(127, 29, 29, 0.15) 0%, rgba(153, 27, 27, 0.2) 100%);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.1);
        }
        
        .bg-yellow-500 {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            box-shadow: 0 4px 16px rgba(251, 191, 36, 0.3);
        }

        /* === INPUT FOCUS STATES === */
        input:focus, textarea:focus {
            outline: 2px solid #fbbf24;
            outline-offset: 2px;
        }

        /* === SMOOTH SCROLLING === */
        html {
            scroll-behavior: smooth;
        }

        /* === LOADING ANIMATION === */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.5s ease;
        }
    </style>
</head>
<body class="bg-black text-white font-sans overflow-x-hidden">
    
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-badge hidden">
        üî¥ Keine Internetverbindung
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="hidden fixed inset-0 z-[10000] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-zinc-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl border border-zinc-700 relative animate-fadeIn">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-zinc-500 hover:text-white font-bold text-xl transition-colors">‚úï</button>
            <h3 class="text-yellow-500 font-black uppercase text-lg mb-1">Details</h3>
            <p id="modal-date" class="text-xs text-zinc-400 font-bold mb-4">DATUM</p>
            
            <div class="space-y-4">
                <div class="bg-zinc-900 p-4 rounded-xl border border-zinc-700">
                    <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">Gebucht von / Status</p>
                    <p id="modal-user" class="text-sm font-bold text-white">...</p>
                </div>

                <div class="bg-zinc-900 p-4 rounded-xl border border-zinc-700">
                    <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">Buchungsgrund (optional)</p>
                    <p id="modal-reason-user" class="text-xs text-white italic">Keine Info</p>
                </div>

                <div id="admin-note-area" class="bg-zinc-900 p-4 rounded-xl border border-zinc-700">
                    <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">Anmerkung</p>
                    <textarea id="modal-reason-admin" class="w-full bg-zinc-800 text-white text-sm p-3 rounded-lg outline-none border border-zinc-700" rows="3" placeholder="Noch keine Anmerkung vorhanden..."></textarea>
                    <button id="btn-save-note" onclick="saveAdminNote()" class="hidden w-full mt-3 bg-yellow-500 text-black text-[10px] font-black py-3 rounded-lg uppercase hover:bg-yellow-400 transition-colors">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-[10000] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-zinc-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl border border-zinc-700 animate-fadeIn">
            <h3 class="text-yellow-500 font-black uppercase text-lg mb-2">Best√§tigung</h3>
            <p id="confirm-message" class="text-sm text-zinc-300 mb-6 leading-relaxed"></p>
            <div class="flex gap-3">
                <button onclick="cancelConfirm()" class="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white py-4 rounded-xl font-bold text-sm transition-colors">Abbrechen</button>
                <button id="confirm-yes-btn" onclick="confirmAction()" class="flex-1 bg-yellow-500 hover:bg-yellow-400 text-black py-4 rounded-xl font-bold text-sm transition-colors">Best√§tigen</button>
            </div>
        </div>
    </div>

    <!-- Input Modal -->
    <div id="input-modal" class="hidden fixed inset-0 z-[10000] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-zinc-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl border border-zinc-700 animate-fadeIn">
            <h3 id="input-title" class="text-yellow-500 font-black uppercase text-lg mb-2">Eingabe</h3>
            <p id="input-label" class="text-xs text-zinc-400 mb-3"></p>
            <input id="input-field" type="text" class="w-full p-4 bg-zinc-900 text-white rounded-xl outline-none border border-zinc-700" placeholder="">
            <div class="flex gap-3 mt-4">
                <button onclick="cancelInput()" class="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white py-4 rounded-xl font-bold text-sm transition-colors">Abbrechen</button>
                <button onclick="submitInput()" class="flex-1 bg-yellow-500 hover:bg-yellow-400 text-black py-4 rounded-xl font-bold text-sm transition-colors">OK</button>
            </div>
        </div>
    </div>

    <!-- iOS Install Info Modal -->
    <div id="ios-install-modal" class="hidden fixed inset-0 z-[10000] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-zinc-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl border border-zinc-700 animate-fadeIn">
            <h3 class="text-yellow-500 font-black uppercase text-lg mb-4 text-center">üì± App installieren</h3>
            <div class="space-y-4 text-sm text-zinc-300">
                <div class="flex gap-3 items-start">
                    <span class="bg-yellow-500 text-black font-black w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs">1</span>
                    <p>Tippe unten auf das <strong class="text-white">Teilen-Symbol</strong> 
                        <svg class="inline w-4 h-4 mx-1" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                        </svg>
                    </p>
                </div>
                <div class="flex gap-3 items-start">
                    <span class="bg-yellow-500 text-black font-black w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs">2</span>
                    <p>W√§hle <strong class="text-white">"Zum Home-Bildschirm"</strong></p>
                </div>
                <div class="flex gap-3 items-start">
                    <span class="bg-yellow-500 text-black font-black w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs">3</span>
                    <p>Best√§tige mit <strong class="text-white">"Hinzuf√ºgen"</strong></p>
                </div>
            </div>
            <button onclick="closeInstallModal()" class="w-full mt-6 bg-yellow-500 hover:bg-yellow-400 text-black py-4 rounded-xl font-bold text-sm transition-colors">Verstanden</button>
        </div>
    </div>

    <div id="app-container" class="max-w-md mx-auto min-h-screen p-4 bg-zinc-900 shadow-2xl pb-60 relative">
        
        <!-- Status Banner -->
        <div id="status-banner" class="hidden mb-6 p-5 rounded-2xl text-center shadow-lg border-2 animate-fadeIn">
            <h2 id="status-headline" class="text-sm font-black uppercase mb-1"></h2>
            <p id="status-subline" class="text-[10px] font-bold opacity-80"></p>
        </div>

        <!-- Loading Screen -->
        <div id="loading" class="flex flex-col items-center py-20 text-yellow-500 font-bold animate-pulse text-sm">
            SYSTEM STARTET...
        </div>

        <!-- Error Display -->
        <div id="error-display" class="hidden py-20 text-center text-red-500 px-10">
            <p class="font-bold text-base">FEHLER BEIM LADEN</p>
            <p id="error-msg" class="text-[10px] mt-2 text-zinc-500"></p>
            <button onclick="handleLogout()" class="mt-5 text-white underline bg-zinc-800 hover:bg-zinc-700 px-5 py-3 rounded-xl transition-colors">Notfall Logout</button>
        </div>

        <!-- Auth Section -->
        <div id="auth-section" class="hidden min-h-screen flex flex-col justify-center items-center px-6 animate-fadeIn relative">
            <!-- Decorative Background Elements -->
            <div class="absolute inset-0 overflow-hidden pointer-events-none">
                <div class="absolute top-20 left-10 w-32 h-32 bg-yellow-500/10 rounded-full blur-3xl"></div>
                <div class="absolute bottom-32 right-10 w-40 h-40 bg-yellow-500/10 rounded-full blur-3xl"></div>
            </div>
            
            <!-- Logo & Title Section -->
            <div class="text-center mb-12 relative z-10">
                <div class="inline-block mb-6">
                    <!-- Animated Calendar with Current Day -->
                    <div class="relative w-24 h-24 mx-auto">
                        <div class="absolute inset-0 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-2xl shadow-2xl transform hover:scale-105 transition-transform duration-300"></div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <div class="text-[10px] font-black text-black/60 uppercase tracking-wider mb-1" id="login-calendar-month"></div>
                            <div class="text-4xl font-black text-black" id="login-calendar-day"></div>
                        </div>
                        <div class="absolute -top-1 left-0 right-0 h-3 bg-red-500 rounded-t-2xl"></div>
                    </div>
                </div>
                <h1 class="text-5xl font-black mb-3 tracking-tight">
                    <span class="bg-gradient-to-r from-yellow-400 via-yellow-500 to-yellow-600 bg-clip-text text-transparent">
                        Springerplan
                    </span>
                </h1>
                <div class="flex items-center justify-center gap-2 text-zinc-500">
                    <div class="h-px w-8 bg-zinc-700"></div>
                    <p class="text-xs font-bold uppercase tracking-widest">made by Flo</p>
                    <div class="h-px w-8 bg-zinc-700"></div>
                </div>
            </div>
            
            <!-- Login Form -->
            <div class="w-full max-w-sm space-y-4 relative z-10">
                <!-- Email Input -->
                <div class="relative">
                    <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none text-zinc-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                        </svg>
                    </div>
                    <input id="email" type="email" placeholder="E-Mail Adresse" 
                           class="w-full pl-12 pr-5 py-5 bg-zinc-800/50 backdrop-blur-sm rounded-2xl outline-none border-2 border-zinc-700/50 text-base transition-all focus:border-yellow-500/50 focus:bg-zinc-800">
                </div>
                
                <!-- Password Input -->
                <div class="relative">
                    <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none text-zinc-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <input id="password" type="password" placeholder="Passwort" 
                           class="w-full pl-12 pr-5 py-5 bg-zinc-800/50 backdrop-blur-sm rounded-2xl outline-none border-2 border-zinc-700/50 text-base transition-all focus:border-yellow-500/50 focus:bg-zinc-800">
                </div>
                
                <!-- Signup Fields -->
                <div id="signup-fields" class="hidden space-y-4 pt-2">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none text-zinc-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <input id="display_name" type="text" placeholder="Vor & Nachname" 
                               class="w-full pl-12 pr-5 py-5 bg-zinc-800/50 backdrop-blur-sm rounded-2xl outline-none border-2 border-zinc-700/50 text-base transition-all focus:border-yellow-500/50 focus:bg-zinc-800">
                    </div>
                    
                    <div class="relative">
                        <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none text-zinc-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <input id="store_number" type="text" placeholder="z.B. 039, 079, 109" maxlength="3" pattern="[0-9]{3}" inputmode="numeric"
                               class="w-full pl-12 pr-5 py-5 bg-zinc-800/50 backdrop-blur-sm rounded-2xl outline-none border-2 border-zinc-700/50 text-base transition-all focus:border-yellow-500/50 focus:bg-zinc-800"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 3)">
                    </div>
                    
                    <div class="relative">
                        <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none text-zinc-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                            </svg>
                        </div>
                        <input id="reg_code" type="text" placeholder="Registrierungs-Code" 
                               class="w-full pl-12 pr-5 py-5 bg-zinc-800/50 backdrop-blur-sm rounded-2xl outline-none border-2 border-zinc-700/50 text-base transition-all focus:border-yellow-500/50 focus:bg-zinc-800">
                    </div>
                </div>
                
                <!-- Login Button -->
                <button id="auth-btn-main" onclick="handleAuthAction()" 
                        class="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-400 hover:to-yellow-500 text-black font-black py-5 rounded-2xl uppercase text-sm transition-all shadow-xl hover:shadow-2xl hover:shadow-yellow-500/20 active:scale-[0.98]">
                    Login
                </button>
                
                <!-- Toggle Button -->
                <div class="text-center pt-4">
                    <button id="toggle-auth-btn" onclick="toggleAuthMode()" 
                            class="text-zinc-400 hover:text-yellow-500 text-sm font-semibold transition-colors">
                        Noch kein Konto? <span class="text-yellow-500">Jetzt registrieren</span>
                    </button>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="mt-16 text-center text-zinc-600 text-xs relative z-10">
                <p>¬© 2026 Springerplan ‚Ä¢ Version 4.0</p>
            </div>
        </div>

        <!-- Main App Content -->
        <div id="main-section" class="hidden space-y-6 animate-fadeIn">
            
            <!-- User Info Header -->
            <div class="bg-zinc-800 p-6 rounded-3xl border border-zinc-700">
                <div class="flex justify-between items-start gap-4">
                    <div class="flex-1">
                        <p id="user-welcome" class="text-xl font-black text-yellow-500"></p>
                        <p id="user-store" class="text-[11px] text-zinc-400 font-bold mt-1"></p>
                        <button onclick="handleLogout()" class="mt-4 text-red-400 hover:text-red-300 underline text-[10px] font-bold transition-colors">Logout</button>
                    </div>
                    <button id="install-btn" onclick="handleInstallPrompt()" class="hidden bg-yellow-500 hover:bg-yellow-400 text-black font-black px-3 py-2 rounded-xl text-[9px] uppercase transition-all shadow-lg flex items-center gap-1 flex-shrink-0">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m0 0l-4-4m4 4l4-4M3 20h18"></path>
                        </svg>
                        <span>App auf<br>Homescreen</span>
                    </button>
                </div>
            </div>

            <!-- Color Legend -->
            <div class="bg-zinc-800 p-5 rounded-2xl border border-zinc-700">
                <h3 class="text-[10px] text-zinc-500 uppercase font-bold mb-4 tracking-wide">Farblegende</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div class="legend-item"><div class="legend-box day-free"></div><span>Frei</span></div>
                    <div class="legend-item"><div class="legend-box day-busy"></div><span>Gebucht</span></div>
                    <div class="legend-item"><div class="legend-box day-pending"></div><span>Anfrage</span></div>
                    <div class="legend-item"><div class="legend-box day-vacation"></div><span>Urlaub</span></div>
                    <div class="legend-item"><div class="legend-box day-sick"></div><span>Krank</span></div>
                    <div class="legend-item"><div class="legend-box day-planned-free"></div><span>Geplant Frei</span></div>
                </div>
            </div>

            <!-- Calendar Section -->
            <div class="bg-zinc-800 p-5 rounded-3xl border border-zinc-700">
                <div class="flex justify-between items-center mb-5">
                    <button onclick="changeMonth(-1)" class="bg-zinc-700 hover:bg-zinc-600 w-12 h-12 rounded-full font-black text-xl transition-all shadow-lg">‚Üê</button>
                    <h2 id="month-name" class="text-base font-black uppercase text-yellow-500 tracking-wide">MONAT</h2>
                    <button onclick="changeMonth(1)" class="bg-zinc-700 hover:bg-zinc-600 w-12 h-12 rounded-full font-black text-xl transition-all shadow-lg">‚Üí</button>
                </div>
                
                <!-- Refresh Info & Button -->
                <div class="mb-4 bg-zinc-900/50 p-3 rounded-xl border border-zinc-700/50 flex items-center justify-between gap-3">
                    <div class="flex-1">
                        <p class="text-[9px] text-zinc-400 leading-relaxed">
                            <span class="font-bold text-yellow-500">üí° Tipp:</span> Wenn du l√§nger nicht hier warst, bitte zuerst aktualisieren.
                        </p>
                    </div>
                    <button onclick="refreshCalendar()" class="bg-yellow-500 hover:bg-yellow-400 text-black font-black px-4 py-2 rounded-lg text-[10px] uppercase transition-all shadow-md flex items-center gap-1 flex-shrink-0">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span>Aktualisieren</span>
                    </button>
                </div>
                
                <div class="day-grid text-[9px] text-zinc-500 font-bold mb-3">
                    <div class="text-center">MO</div><div class="text-center">DI</div><div class="text-center">MI</div><div class="text-center">DO</div><div class="text-center">FR</div><div class="text-center">SA</div>
                </div>
                
                <div id="calendar-grid" class="day-grid"></div>
            </div>

            <!-- User Bookings List -->
            <div class="bg-zinc-800 p-5 rounded-3xl border border-zinc-700">
                <h3 class="text-[10px] text-zinc-500 uppercase font-bold mb-4 tracking-wide">Meine Buchungen</h3>
                <div id="booking-list" class="space-y-2"></div>
                <button id="toggle-bookings-btn" onclick="toggleBookingsList()" class="hidden w-full mt-3 text-zinc-500 hover:text-zinc-400 text-[10px] font-bold underline transition-colors">
                    Alle anzeigen
                </button>
            </div>

            <!-- Admin Panel -->
            <div id="admin-panel" class="hidden space-y-6">
                
                <!-- Admin Status Toggle -->
                <div class="bg-yellow-500 text-black p-6 rounded-3xl shadow-xl">
                    <h3 class="text-[10px] uppercase font-black mb-4 tracking-wide">Admin Status</h3>
                    <div class="flex gap-3">
                        <button id="status-sick-state" onclick="toggleGlobalStatus('sick')" class="flex-1 bg-red-600 hover:bg-red-500 text-white font-black py-4 rounded-xl text-[11px] uppercase transition-all shadow-lg">Krank: AUS</button>
                        <button id="status-vacation-state" onclick="toggleGlobalStatus('vacation')" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl text-[11px] uppercase transition-all shadow-lg">Urlaub: AUS</button>
                    </div>
                </div>

                <!-- Admin Calendar -->
                <div class="bg-red-900/20 border-2 border-red-500 p-5 rounded-3xl">
                    <h3 class="text-red-500 font-black text-base uppercase mb-5 tracking-wide">Admin Kalender-Editor</h3>
                    <div class="day-grid text-[9px] text-zinc-500 font-bold mb-3">
                        <div class="text-center">MO</div><div class="text-center">DI</div><div class="text-center">MI</div><div class="text-center">DO</div><div class="text-center">FR</div><div class="text-center">SA</div>
                    </div>
                    <div id="admin-calendar-grid" class="day-grid"></div>
                </div>

                <!-- Pending Requests -->
                <div class="bg-zinc-800 p-5 rounded-3xl border border-zinc-700">
                    <h3 class="text-[10px] text-zinc-500 uppercase font-bold mb-4 tracking-wide">Offene Anfragen</h3>
                    <div id="admin-list" class="space-y-2"></div>
                </div>

                <!-- User Approval -->
                <div class="bg-zinc-800 p-5 rounded-3xl border border-zinc-700">
                    <h3 class="text-[10px] text-zinc-500 uppercase font-bold mb-4 tracking-wide">Neue User freischalten</h3>
                    <div id="user-approval-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Bar (floating bottom) -->
    <div id="action-bar" class="bg-yellow-500 text-black rounded-[2rem] p-5 shadow-2xl">
        <p id="selection-info" class="text-center font-black text-[11px] mb-4 uppercase tracking-wide">0 Tage ausgew√§hlt</p>
        
        <!-- User Actions -->
        <button id="btn-submit" onclick="submitSelection()" class="w-full bg-black hover:bg-zinc-900 text-yellow-500 font-black py-4 rounded-xl uppercase text-sm mb-3 transition-all shadow-lg">Anfrage senden</button>
        
        <!-- Admin Actions -->
        <div id="admin-actions" class="hidden space-y-2 pt-3 border-t-2 border-black/20">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="submitAdminAction('direkt')" class="bg-red-600 hover:bg-red-500 text-white font-black py-3 rounded-lg text-[10px] uppercase transition-all shadow-md">Direkt buchen</button>
                <button onclick="submitAdminAction('urlaub')" class="bg-blue-600 hover:bg-blue-500 text-white font-black py-3 rounded-lg text-[10px] uppercase transition-all shadow-md">Urlaub</button>
                <button onclick="submitAdminAction('krank')" class="bg-red-900 hover:bg-red-800 text-white font-black py-3 rounded-lg text-[10px] uppercase transition-all shadow-md">Krank</button>
                <button onclick="submitAdminAction('planned_free')" class="bg-purple-600 hover:bg-purple-500 text-white font-black py-3 rounded-lg text-[10px] uppercase transition-all shadow-md">Geplant Frei</button>
            </div>
            <button onclick="submitAdminAction('frei')" class="w-full bg-green-600 hover:bg-green-500 text-white font-black py-3 rounded-lg text-[10px] uppercase transition-all shadow-md">Tage freigeben</button>
        </div>
        
        <button onclick="clearSelection()" class="w-full mt-3 text-black/60 hover:text-black/80 underline text-[10px] font-bold transition-colors">Auswahl l√∂schen</button>
    </div>

    <script>
        // ============================================
        // KONFIGURATION - HIER DEINE DATEN EINTRAGEN
        // ============================================
        
        const SUPABASE_URL = "https://aggpjaxpupqbsefsusok.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnZ3BqYXhwdXBxYnNlZnN1c29rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNzgxOTcsImV4cCI6MjA4NTg1NDE5N30.66Q-q1EIdn4_EWf_TCOanxwQ-_qB6-FaAYdHCYbLkHk"; // NUR ANON KEY!
        
        // EmailJS Konfiguration
        const EJS_PUBLIC_KEY = "MkRGHMZNkwKnmQDLY";
        const EJS_SERVICE = "service_z1cwhnt";
        const EJS_ADMIN_TEMPLATE = "template_avultfe";
        const EJS_USER_TEMPLATE = "template_22cjt73";
        
        // Admin-Email (wird aus Datenbank gelesen, siehe SQL)
        const ADMIN_EMAIL = "def4lt123@gmail.com"; // Backup-Wert
        
        // Registrierungs-Code
        const MASTER_REG_CODE = "FLO2026";
        
        // ============================================
        // GLOBALE VARIABLEN
        // ============================================
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null, userProfile = null, selectedDates = [], currentViewDate = new Date(), currentModalBookingId = null;
        
        let confirmCallback = null, inputCallback = null;
        let showAllBookings = false;
        
        // PWA Install Prompt
        let deferredPrompt = null;

        // ============================================
        // INITIALISIERUNG
        // ============================================
        
        window.addEventListener('load', init);
        
        // PWA Install Prompt Event (Android)
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show install button
            const installBtn = document.getElementById('install-btn');
            if (installBtn) installBtn.classList.remove('hidden');
        });
        
        // PWA Installation erfolgreich
        window.addEventListener('appinstalled', () => {
            deferredPrompt = null;
            const installBtn = document.getElementById('install-btn');
            if (installBtn) installBtn.classList.add('hidden');
            showToast('‚úÖ App erfolgreich installiert!', 'success');
        });
        
        // Auth State Change Listener - erkennt wenn Session auf anderem Ger√§t invalidiert wurde
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT' || event === 'TOKEN_REFRESHED' && !session) {
                // Session wurde auf anderem Ger√§t beendet
                location.reload();
            }
        });
        
        // Offline Detection
        window.addEventListener('online', () => {
            document.getElementById('offline-indicator').classList.add('hidden');
            showToast('‚úÖ Verbindung wiederhergestellt', 'success');
        });
        window.addEventListener('offline', () => {
            document.getElementById('offline-indicator').classList.remove('hidden');
        });

        async function init() {
            // Update login calendar with current date
            updateLoginCalendar();
            
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (!session) {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('auth-section').classList.remove('hidden');
                    return;
                }
                
                currentUser = session.user;
                const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
                
                if (!profile) throw new Error("Profil nicht gefunden");
                if (!profile.is_approved) {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('error-display').classList.remove('hidden');
                    document.getElementById('error-msg').innerText = "Dein Account wurde noch nicht freigeschaltet. Bitte warte auf Flos Best√§tigung.";
                    return;
                }
                
                userProfile = profile;
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-section').classList.remove('hidden');
                
                await loadGlobalStatus();
                renderUserSection();
                
            } catch (err) {
                console.error(err);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error-display').classList.remove('hidden');
                document.getElementById('error-msg').innerText = err.message;
            }
        }

        // Update login calendar with current date
        function updateLoginCalendar() {
            const now = new Date();
            const months = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
            const day = now.getDate();
            const month = months[now.getMonth()];
            
            const dayElement = document.getElementById('login-calendar-day');
            const monthElement = document.getElementById('login-calendar-month');
            
            if (dayElement) dayElement.textContent = day;
            if (monthElement) monthElement.textContent = month;
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#18181b';
            toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function setBtnLoading(btnId, isLoading, text = '') {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            if (isLoading) {
                btn.classList.add('btn-loading');
                btn.innerHTML = `<span class="spinner"></span>${text}`;
            } else {
                btn.classList.remove('btn-loading');
                btn.innerHTML = btn.getAttribute('data-original-text') || text;
            }
        }

        // Modal Helpers
        function showConfirm(message, callback) {
            document.getElementById('confirm-message').innerText = message;
            document.getElementById('confirm-modal').classList.remove('hidden');
            confirmCallback = callback;
        }

        function cancelConfirm() {
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmCallback = null;
        }

        function confirmAction() {
            document.getElementById('confirm-modal').classList.add('hidden');
            if (confirmCallback) confirmCallback();
            confirmCallback = null;
        }

        function showInput(title, label, placeholder, callback, options = {}) {
            document.getElementById('input-title').innerText = title;
            document.getElementById('input-label').innerText = label;
            const inputField = document.getElementById('input-field');
            inputField.placeholder = placeholder;
            inputField.value = '';
            
            // Optionale numerische Validierung
            if (options.numericOnly) {
                inputField.type = 'text';
                inputField.inputMode = 'numeric';
                inputField.maxLength = options.maxLength || '';
                inputField.oninput = function() {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    if (options.maxLength) {
                        this.value = this.value.slice(0, options.maxLength);
                    }
                };
            } else {
                inputField.type = 'text';
                inputField.inputMode = 'text';
                inputField.maxLength = '';
                inputField.oninput = null;
            }
            
            document.getElementById('input-modal').classList.remove('hidden');
            inputCallback = callback;
        }

        function cancelInput() {
            document.getElementById('input-modal').classList.add('hidden');
            if (inputCallback) inputCallback(null);
            inputCallback = null;
        }

        function submitInput() {
            const value = document.getElementById('input-field').value;
            document.getElementById('input-modal').classList.add('hidden');
            if (inputCallback) inputCallback(value);
            inputCallback = null;
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        // ============================================
        // USER SECTION
        // ============================================

        function renderUserSection() {
            if (!userProfile) return;
            document.getElementById('user-welcome').innerText = userProfile.display_name;
            document.getElementById('user-store').innerText = 'Filiale: ' + userProfile.store_number;
            const isAdmin = currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            document.getElementById('admin-panel').classList.toggle('hidden', !isAdmin);
            
            // Show install button if NOT already installed (both iOS and Android)
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
            if (!isStandalone) {
                document.getElementById('install-btn').classList.remove('hidden');
            }
            
            fetchAndRender();
        }

        async function fetchAndRender() {
            const { data } = await supabaseClient.from('bookings').select('*');
            renderCalendar('calendar-grid', data || [], false);
            renderLists(data || []);
            if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                renderCalendar('admin-calendar-grid', data || [], true);
                renderUserApproval();
            }
        }

        async function loadGlobalStatus() {
            const { data } = await supabaseClient.from('profiles').select('admin_status').eq('email', ADMIN_EMAIL).single();
            if (!data || !data.admin_status) return;
            const stat = JSON.parse(data.admin_status);
            const banner = document.getElementById('status-banner'), hl = document.getElementById('status-headline'), sl = document.getElementById('status-subline');
            if (stat.sick) { 
                banner.classList.remove('hidden'); 
                hl.innerText = 'Bin derzeit Krank'; 
                sl.innerText = 'Anfragen werden evtl. Verz√∂gert beantwortet.'; 
                banner.style.background = 'linear-gradient(135deg, #fca5a5 0%, #f87171 100%)'; 
                banner.style.color = '#7f1d1d'; 
            } else if (stat.vacation) { 
                banner.classList.remove('hidden'); 
                hl.innerText = 'Bin aktuell im Urlaub'; 
                sl.innerText = 'Anfragen werden evtl. Verz√∂gert beantwortet.'; 
                banner.style.background = 'linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%)'; 
                banner.style.color = '#1e3a8a'; 
            } else { 
                banner.classList.add('hidden'); 
            }
            if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                document.getElementById('status-sick-state').innerText = stat.sick ? 'Krank: AN' : 'Krank: AUS';
                document.getElementById('status-vacation-state').innerText = stat.vacation ? 'Urlaub: AN' : 'Urlaub: AUS';
                document.getElementById('status-sick-state').style.background = stat.sick ? '#dc2626' : '#991b1b';
                document.getElementById('status-vacation-state').style.background = stat.vacation ? '#2563eb' : '#1e40af';
            }
        }

        function renderCalendar(targetId, allBookings, isArchiveMode) {
            const grid = document.getElementById(targetId);
            if (!grid) return; grid.innerHTML = '';
            
            const year = currentViewDate.getFullYear(), month = currentViewDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDay = (new Date(year, month, 1).getDay() + 6) % 7;
            
            // FIX: String-Vergleich statt Date-Objekt-Vergleich
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            if (targetId === 'calendar-grid') {
                document.getElementById('month-name').innerText = new Intl.DateTimeFormat('de-DE', { month: 'long', year: 'numeric' }).format(currentViewDate);
            }
            
            // Empty cells for offset (Mo-Sa = 0-5, no Sunday)
            for (let x = 0; x < startDay; x++) grid.innerHTML += `<div></div>`;
            
            for (let d = 1; d <= daysInMonth; d++) {
                const dateObj = new Date(year, month, d);
                const dayOfWeek = dateObj.getDay();
                
                // SKIP SUNDAYS (dayOfWeek === 0)
                if (dayOfWeek === 0) continue;
                
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const b = allBookings.find(x => x.requested_date === dateStr && x.status !== 'rejected');
                let cls = "day-free", label = "", disabled = false, isBusy = false;
                
                // FIX: String-Vergleich f√ºr vergangene Tage
                if (!isArchiveMode) { 
                    if (dateStr < todayStr || isAustrianHoliday(dateObj)) { 
                        disabled = true; 
                        cls = "day-disabled"; 
                    } 
                }
                
                // Buchungs-Status (aber nur wenn nicht disabled)
                if (b && !disabled) {
                    isBusy = true; 
                    if (b.status === 'confirmed') { cls = "day-busy"; label = "Fil. " + b.store_number; }
                    else if (b.status === 'pending') { cls = "day-pending"; label = "OFFEN"; }
                    else if (b.status === 'vacation') { cls = "day-vacation"; label = "URLAUB"; }
                    else if (b.status === 'sick') { cls = "day-sick"; label = "KRANK"; }
                    else if (b.status === 'planned_free') { cls = "day-planned-free"; label = "FREI"; }
                }
                
                const isSelected = selectedDates.includes(dateStr) ? 'day-selected' : '';
                const bookingData = b ? JSON.stringify(b).replace(/"/g, '&quot;') : null;
                let clickAction = '';
                
                if (!disabled) { 
                    if (isArchiveMode) { clickAction = `toggleDateSelection('${dateStr}')`; } 
                    else { clickAction = (isBusy && bookingData) ? `openModal(${bookingData})` : `toggleDateSelection('${dateStr}')`; } 
                }
                
                grid.innerHTML += `<div onclick="${clickAction}" class="calendar-day ${cls} ${isSelected}"><span>${d}</span>${label ? `<span class="store-label">${label}</span>` : ''}</div>`;
            }
        }
        
        function openModal(b) {
            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('modal-date').innerText = b.requested_date;
            document.getElementById('modal-user').innerText = `${b.display_name} (${b.status})`;
            document.getElementById('modal-reason-user').innerText = b.reason_user || "Keine Angabe";
            
            const isAdmin = currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            const adminNoteField = document.getElementById('modal-reason-admin');
            const saveBtn = document.getElementById('btn-save-note');
            
            adminNoteField.value = b.reason_admin || "";
            
            if (isAdmin) {
                adminNoteField.readOnly = false;
                saveBtn.classList.remove('hidden');
                currentModalBookingId = b.id;
            } else {
                adminNoteField.readOnly = true;
                saveBtn.classList.add('hidden');
            }
        }

        async function saveAdminNote() {
            const note = document.getElementById('modal-reason-admin').value;
            setBtnLoading('btn-save-note', true, "");
            const { error } = await supabaseClient.from('bookings').update({ reason_admin: note }).eq('id', currentModalBookingId);
            setBtnLoading('btn-save-note', false);
            if (error) {
                showToast('‚ùå Fehler beim Speichern', 'error');
            } else {
                showToast('‚úÖ Notiz gespeichert', 'success');
                closeModal(); 
                fetchAndRender();
            }
        }

        function isAustrianHoliday(date) {
            const y = date.getFullYear(), m = date.getMonth() + 1, d = date.getDate();
            const fixed = ['1.1.', '6.1.', '1.5.', '15.8.', '26.10.', '1.11.', '25.12.', '26.12.'];
            if (fixed.includes(`${d}.${m}.`)) return true;
            const a = y % 19, b = Math.floor(y / 100), c = y % 100, d1 = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25), g = Math.floor((b - f + 1) / 3), h = (19 * a + b - d1 - g + 15) % 30, i = Math.floor(c / 4), k = c % 4, l = (32 + 2 * e + 2 * i - h - k) % 7, m1 = Math.floor((a + 11 * h + 22 * l) / 451), month = Math.floor((h + l - 7 * m1 + 114) / 31), day = ((h + l - 7 * m1 + 114) % 31) + 1;
            const easter = new Date(y, month - 1, day);
            const addDays = (base, n) => { let res = new Date(base); res.setDate(res.getDate() + n); return res; };
            const check = (target) => d === target.getDate() && (m - 1) === target.getMonth();
            return check(addDays(easter, 1)) || check(addDays(easter, 39)) || check(addDays(easter, 50)) || check(addDays(easter, 60));
        }

        function toggleDateSelection(dateStr) {
            if (selectedDates.includes(dateStr)) { 
                selectedDates = selectedDates.filter(x => x !== dateStr); 
            } else { 
                selectedDates.push(dateStr); 
            }
            updateActionBar(); 
            supabaseClient.from('bookings').select('*').then(({data}) => { 
                renderCalendar('calendar-grid', data || [], false); 
                if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) { 
                    renderCalendar('admin-calendar-grid', data || [], true); 
                } 
            });
        }

        function updateActionBar() { 
            const bar = document.getElementById('action-bar'), count = selectedDates.length; 
            bar.classList.toggle('visible', count > 0); 
            
            // Bessere Info-Anzeige
            let infoText = `${count} ${count === 1 ? 'Tag' : 'Tage'} ausgew√§hlt`;
            if (count > 0 && count <= 3) {
                infoText += ': ' + selectedDates.join(', ');
            }
            document.getElementById('selection-info').innerText = infoText;
            
            document.getElementById('admin-actions').classList.toggle('hidden', currentUser.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()); 
        }

        function clearSelection() { 
            selectedDates = []; 
            updateActionBar(); 
            fetchAndRender(); 
        }

        function changeMonth(d) { 
            currentViewDate.setMonth(currentViewDate.getMonth() + d); 
            clearSelection(); 
        }

        function refreshCalendar() {
            showToast('üîÑ Aktualisiere Daten...', 'info');
            clearSelection();
            setTimeout(() => {
                showToast('‚úÖ Kalender aktualisiert!', 'success');
            }, 500);
        }

        // ============================================
        // USER ACTIONS
        // ============================================

        async function submitSelection() {
            if (selectedDates.length === 0) {
                showToast('‚ö†Ô∏è Keine Tage ausgew√§hlt', 'error');
                return;
            }

            showInput(
                'Anfrage senden',
                'Optionale Nachricht/Grund f√ºr die Anfrage:',
                'z.B. *** ist krank',
                async (reason) => {
                    if (reason === null) return; // Abgebrochen
                    
                    setBtnLoading('btn-submit', true, "Sende...");
                    
                    const ins = selectedDates.map(d => ({ 
                        user_id: currentUser.id, 
                        requested_date: d, 
                        display_name: userProfile.display_name, 
                        store_number: userProfile.store_number, 
                        user_email: currentUser.email, 
                        reason_user: reason, 
                        status: 'pending' 
                    }));
                    
                    const { error } = await supabaseClient.from('bookings').insert(ins);
                    
                    if (!error) { 
                        emailjs.init(EJS_PUBLIC_KEY); 
                        emailjs.send(EJS_SERVICE, EJS_ADMIN_TEMPLATE, { 
                            user_name: userProfile.display_name, 
                            store_number: userProfile.store_number, 
                            date: selectedDates.join(", "), 
                            reason: reason || "-" 
                        }); 
                        showToast('‚úÖ Anfrage erfolgreich gesendet!', 'success');
                        
                        // Page Refresh nach erfolgreicher Anfrage
                        setTimeout(() => location.reload(), 800);
                    } else {
                        showToast('‚ùå Fehler: ' + error.message, 'error');
                        setBtnLoading('btn-submit', false);
                    }
                }
            );
        }

        // ============================================
        // ADMIN ACTIONS
        // ============================================

        async function toggleGlobalStatus(type) {
            const { data } = await supabaseClient.from('profiles').select('admin_status').eq('email', ADMIN_EMAIL).single();
            let stat = data && data.admin_status ? JSON.parse(data.admin_status) : {};
            stat[type] = !stat[type];
            if (type === 'sick' && stat[type]) stat.vacation = false;
            if (type === 'vacation' && stat[type]) stat.sick = false;
            await supabaseClient.from('profiles').update({ admin_status: JSON.stringify(stat) }).eq('email', ADMIN_EMAIL);
            loadGlobalStatus();
            showToast(`‚úÖ ${type === 'sick' ? 'Krank' : 'Urlaub'}-Status aktualisiert`, 'success');
        }

        async function submitAdminAction(type) {
            if (selectedDates.length === 0) { 
                showToast('‚ö†Ô∏è Keine Tage ausgew√§hlt', 'error'); 
                return; 
            }
            
            const insData = (status, number, name) => selectedDates.map(d => ({ 
                user_id: currentUser.id, 
                requested_date: d, 
                status, 
                store_number: number, 
                display_name: name, 
                user_email: currentUser.email 
            }));

            if (type === 'direkt') {
                showInput(
                    'Direkt buchen',
                    'Filiale eingeben (3 Zahlen):',
                    'z.B. 039, 079, 109',
                    async (fil) => {
                        if (!fil) return;
                        
                        // Validierung: genau 3 Zahlen erforderlich
                        if (fil.length !== 3) {
                            showToast('‚ùå Bitte genau 3 Zahlen eingeben', 'error');
                            return;
                        }
                        
                        // Name automatisch aus Admin-Profil holen
                        const { data: profile } = await supabaseClient.from('profiles').select('display_name').eq('id', currentUser.id).single();
                        const adminName = profile ? profile.display_name : 'Admin';
                        
                        const { error } = await supabaseClient.from('bookings').insert(insData('confirmed', fil, adminName));
                        if (error) {
                            showToast('‚ùå Fehler: ' + error.message, 'error');
                        } else {
                            showToast('‚úÖ Direkt gebucht', 'success');
                            clearSelection();
                        }
                    },
                    { numericOnly: true, maxLength: 3 }
                );
            } else if (type === 'urlaub') {
                showConfirm(
                    `${selectedDates.length} Tage als URLAUB markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('vacation', 'URLAUB', 'Admin'));
                        showToast('‚úÖ Urlaub eingetragen', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'krank') {
                showConfirm(
                    `${selectedDates.length} Tage als KRANK markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('sick', 'KRANK', 'Admin'));
                        showToast('‚úÖ Krankmeldung eingetragen', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'planned_free') {
                showConfirm(
                    `${selectedDates.length} Tage als GEPLANT FREI markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('planned_free', 'FREI', 'Admin'));
                        showToast('‚úÖ Geplant Frei eingetragen', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'frei') {
                showConfirm(
                    `${selectedDates.length} Tage FREIGEBEN (alle Buchungen l√∂schen)?`,
                    async () => {
                        await supabaseClient.from('bookings').delete().in('requested_date', selectedDates);
                        showToast('‚úÖ Tage freigegeben', 'success');
                        clearSelection();
                    }
                );
            }
        }

        async function renderUserApproval() {
            const list = document.getElementById('user-approval-list');
            const { data: users } = await supabaseClient.from('profiles').select('*').eq('is_approved', false);
            if (!users || users.length === 0) { 
                list.innerHTML = '<p class="text-[9px] text-zinc-600">Keine neuen User</p>'; 
                return; 
            }
            list.innerHTML = '';
            users.forEach(u => {
                list.innerHTML += `<div class="bg-white text-black p-3 rounded-xl flex justify-between items-center mb-2"><div class="text-left font-black text-[8px]">${u.display_name}<br><span class="font-normal">Filiale ${u.store_number}</span></div><button onclick="approveUser('${u.id}')" class="bg-blue-600 text-white px-3 py-2 rounded-lg font-black uppercase text-[7px]">OK</button></div>`;
            });
        }

        async function approveUser(uid) { 
            await supabaseClient.from('profiles').update({ is_approved: true }).eq('id', uid); 
            showToast('‚úÖ User freigeschaltet', 'success');
            fetchAndRender(); 
        }

        function renderLists(data) {
            const uL = document.getElementById('booking-list'), aL = document.getElementById('admin-list');
            uL.innerHTML = ''; 
            const pending = data.filter(x => x.status === 'pending');
            
            if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                aL.innerHTML = pending.length ? '' : '<p class="text-[9px] text-zinc-600">Keine Anfragen</p>';
                pending.forEach(b => {
                    aL.innerHTML += `<div class="bg-white text-black p-3 rounded-2xl flex justify-between items-center text-[8px] font-bold"><div>${b.requested_date}<br><span class="text-zinc-500">${b.display_name}</span></div><div class="flex gap-1"><button onclick="processRequest(this, '${b.id}','confirmed','${b.user_email}','${b.requested_date}')" class="bg-green-600 text-white px-3 py-2 rounded-lg">‚úì</button><button onclick="processRequest(this, '${b.id}','rejected','${b.user_email}','${b.requested_date}')" class="bg-red-600 text-white px-3 py-2 rounded-lg">X</button></div></div>`;
                });
            }
            
            const userBookings = data.filter(x => x.user_id === currentUser.id).sort((a,b) => b.requested_date.localeCompare(a.requested_date));
            const toggleBtn = document.getElementById('toggle-bookings-btn');
            
            if (userBookings.length === 0) {
                uL.innerHTML = '<p class="text-[9px] text-zinc-600">Noch keine Buchungen</p>';
                if (toggleBtn) toggleBtn.classList.add('hidden');
            } else {
                // Collapsible: Show only 5 if more than 5 exist
                const displayCount = showAllBookings ? userBookings.length : Math.min(5, userBookings.length);
                const displayBookings = userBookings.slice(0, displayCount);
                
                displayBookings.forEach(b => {
                    uL.innerHTML += `<div onclick='openModal(${JSON.stringify(b)})' class="p-4 bg-zinc-800/30 rounded-2xl flex justify-between items-center text-[9px] font-bold border border-zinc-800 cursor-pointer hover:bg-zinc-800/50 transition-colors"><div>${b.requested_date}</div><div class="uppercase text-yellow-500">${b.status}</div></div>`;
                });
                
                // Show toggle button only if more than 5 bookings
                if (toggleBtn) {
                    if (userBookings.length > 5) {
                        toggleBtn.classList.remove('hidden');
                        toggleBtn.innerText = showAllBookings ? 'Weniger anzeigen' : `Alle ${userBookings.length} anzeigen`;
                    } else {
                        toggleBtn.classList.add('hidden');
                    }
                }
            }
        }

        // Toggle function for collapsible bookings
        function toggleBookingsList() {
            showAllBookings = !showAllBookings;
            fetchAndRender();
        }

        async function processRequest(btn, id, status, email, date) {
            if (status === 'rejected') {
                showInput(
                    'Anfrage ablehnen',
                    'Ablehnungsgrund (optional):',
                    'z.B. "An diesem Tag bereits verplant..."',
                    async (reason) => {
                        btn.innerText = '..';
                        await supabaseClient.from('bookings').update({ status, reason_admin: reason }).eq('id', id);
                        
                        if (email) {
                            emailjs.init(EJS_PUBLIC_KEY);
                            const adminNote = reason ? `Grund: ${reason}` : '';
                            await emailjs.send(EJS_SERVICE, EJS_USER_TEMPLATE, { 
                                email: email, 
                                status_text: 'ABGELEHNT', 
                                date: date,
                                admin_note: adminNote
                            });
                        }
                        showToast('‚úÖ Anfrage abgelehnt', 'success');
                        fetchAndRender();
                    }
                );
            } else {
                // Best√§tigung
                btn.innerText = '..';
                await supabaseClient.from('bookings').update({ status }).eq('id', id);
                
                if (email) {
                    emailjs.init(EJS_PUBLIC_KEY);
                    await emailjs.send(EJS_SERVICE, EJS_USER_TEMPLATE, { 
                        email: email, 
                        status_text: 'BEST√ÑTIGT', 
                        date: date,
                        admin_note: ''
                    });
                }
                showToast('‚úÖ Anfrage best√§tigt', 'success');
                fetchAndRender();
            }
        }

        // ============================================
        // AUTH FUNCTIONS
        // ============================================

        async function handleAuthAction() {
            setBtnLoading('auth-btn-main', true, "...");
            const email = document.getElementById('email').value, password = document.getElementById('password').value;
            try {
                if (document.getElementById('signup-fields').classList.contains('hidden')) {
                    // SINGLE SESSION: Bei Login alle anderen Sessions beenden
                    const { data, error } = await supabaseClient.auth.signInWithPassword({ 
                        email, 
                        password 
                    });
                    if (error) throw error;
                    
                    // Alle anderen Sessions des Users beenden (au√üer der aktuellen)
                    // Supabase macht das automatisch bei signInWithPassword - alte Sessions werden invalidiert
                    location.reload();
                } else {
                    const name = document.getElementById('display_name').value;
                    const store = document.getElementById('store_number').value;
                    const code = document.getElementById('reg_code').value;
                    if (code.toUpperCase() !== MASTER_REG_CODE) throw new Error("Registrierungs-Code falsch");
                    const { error } = await supabaseClient.auth.signUp({ email, password, options: { data: { display_name: name, store_number: store } } });
                    if (error) throw error;
                    emailjs.init(EJS_PUBLIC_KEY);
                    await emailjs.send(EJS_SERVICE, EJS_ADMIN_TEMPLATE, { user_name: name, store_number: store, date: "NEUE ANMELDUNG", reason: "Wartet auf Freischaltung" });
                    showToast('‚úÖ Registriert! Warte auf Freischaltung.', 'success');
                    location.reload(); 
                }
            } catch (err) { 
                showToast('‚ùå ' + err.message, 'error');
                setBtnLoading('auth-btn-main', false); 
            }
        }

        function toggleAuthMode() { 
            const isHidden = document.getElementById('signup-fields').classList.toggle('hidden'); 
            document.getElementById('toggle-auth-btn').innerText = isHidden ? "Konto erstellen" : "Zum Login"; 
            document.getElementById('auth-btn-main').innerText = isHidden ? "Login" : "Registrieren"; 
        }

        async function handleLogout() { 
            await supabaseClient.auth.signOut(); 
            location.reload(); 
        }

        // ============================================
        // PWA INSTALL FUNCTIONS
        // ============================================

        function handleInstallPrompt() {
            // Detect iOS
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            if (isIOS) {
                // Show iOS instructions
                document.getElementById('ios-install-modal').classList.remove('hidden');
            } else if (deferredPrompt) {
                // Android: Trigger native install prompt
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showToast('‚úÖ Installation gestartet...', 'success');
                    }
                    deferredPrompt = null;
                    document.getElementById('install-btn').classList.add('hidden');
                });
            } else {
                // Android without native prompt OR already installed
                // Show manual instructions
                showAndroidInstallInstructions();
            }
        }

        function showAndroidInstallInstructions() {
            showConfirm(
                'Um die App zum Homescreen hinzuzuf√ºgen:\n\n1. √ñffne das Browser-Men√º (‚ãÆ oder ‚â°)\n   ‚Ä¢ Chrome: Men√º (‚ãÆ) oben rechts\n   ‚Ä¢ Samsung: Men√º (‚â°) unten rechts\n   ‚Ä¢ Firefox: Men√º (‚ãÆ) oben rechts\n\n2. Tippe auf "Zum Startbildschirm hinzuf√ºgen" oder "App installieren"\n\n3. Best√§tige mit "Zum Home-Bildschirm hinzuf√ºgen"\n\nHinweis: Die App ist m√∂glicherweise bereits installiert.',
                () => {}
            );
        }

        function closeInstallModal() {
            document.getElementById('ios-install-modal').classList.add('hidden');
        }
    </script>
</body>
</html>
