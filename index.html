<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#18181b">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/96/calendar--v1.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/96/calendar--v1.png">
    
    <title>Springerplan made by Flo - V4.2</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        .day-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.7rem; font-weight: bold; cursor: pointer; position: relative; transition: transform 0.1s ease; border: 2px solid transparent; touch-action: manipulation; }
        
        .day-free { background-color: #22c55e; color: white; } 
        .day-busy { background-color: #ef4444; color: white; } 
        .day-pending { background-color: #eab308; color: black; }
        .day-vacation { background-color: #3b82f6; color: white; }
        .day-sick { background-color: #7f1d1d; color: white; border: 1px solid #f87171; }
        .day-planned-free { background-color: #9333ea; color: white; }
        
        .day-disabled { background-color: #3f3f46 !important; color: #71717a !important; cursor: not-allowed !important; opacity: 0.5; pointer-events: none; }
        .day-selected { border: 3px solid #ffffff !important; transform: scale(0.92); z-index: 10; }
        .store-label { font-size: 0.4rem; background: rgba(0,0,0,0.4); width: 100%; text-align: center; position: absolute; bottom: 0; border-radius: 0 0 10px 10px; pointer-events: none; }
        
        .spinner { border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 2px solid white; width: 12px; height: 12px; animation: spin 1s linear infinite; display: inline-block; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-loading { opacity: 0.7; cursor: wait !important; pointer-events: none; }

        #detail-modal, #confirm-modal, #input-modal { backdrop-filter: blur(5px); }
        
        #action-bar { 
            position: fixed; 
            bottom: calc(20px + env(safe-area-inset-bottom)); 
            left: 50%; 
            transform: translate(-50%, 200%); 
            z-index: 9999; 
            width: 92%; 
            max-width: 400px;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        #action-bar.visible { 
            transform: translate(-50%, 0); 
            opacity: 1;
            pointer-events: auto;
        }
        #app-container { padding-bottom: 120px !important; }
        
        * { user-select: none; -webkit-tap-highlight-color: transparent; }
        input, textarea { user-select: auto !important; }

        /* Legend Styles */
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.65rem; }
        .legend-box { width: 16px; height: 16px; border-radius: 4px; flex-shrink: 0; }

        /* Toast Notification */
        .toast { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: #18181b; 
            color: white; 
            padding: 12px 20px; 
            border-radius: 12px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 10001;
            animation: slideIn 0.3s ease;
            border: 1px solid #3f3f46;
        }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Offline Indicator */
        .offline-badge { 
            position: fixed; 
            top: 10px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #ef4444; 
            color: white; 
            padding: 6px 16px; 
            border-radius: 20px; 
            font-size: 0.65rem; 
            font-weight: bold; 
            z-index: 10002;
            animation: pulse 2s infinite;
        }

        /* Pull-to-Refresh Styles */
        .pull-to-refresh {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, #18181b 0%, transparent 100%);
            z-index: 9998;
            opacity: 0;
            transform: translateY(-60px);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        .pull-to-refresh.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .pull-to-refresh.refreshing {
            opacity: 1;
            transform: translateY(0);
        }

        /* Collapsible List Styles */
        .booking-item-hidden {
            display: none;
        }
        .expand-button {
            transition: all 0.2s ease;
        }
        .expand-button:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="bg-black text-white font-sans overflow-x-hidden">
    
    <!-- Pull-to-Refresh Indicator -->
    <div id="pull-refresh-indicator" class="pull-to-refresh">
        <div class="text-zinc-400 text-xs font-bold flex items-center gap-2">
            <div class="spinner"></div>
            <span id="pull-refresh-text">Ziehen zum Aktualisieren...</span>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-badge hidden">
        üî¥ Keine Internetverbindung
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="hidden fixed inset-0 z-[10000] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-zinc-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl border border-zinc-700 relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-zinc-500 font-bold text-xl">‚úï</button>
            <h3 class="text-yellow-500 font-black uppercase text-lg mb-1">Details</h3>
            <p id="modal-date" class="text-xs text-zinc-400 font-bold mb-4">DATUM</p>
            
            <div class="space-y-4">
                <div class="bg-zinc-900 p-3 rounded-xl border border-zinc-700">
                    <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">Gebucht von / Status</p>
                    <p id="modal-user" class="text-sm font-bold text-white">...</p>
                </div>

                <div class="bg-zinc-900 p-3 rounded-xl border border-zinc-700">
                    <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">Buchungsgrund (optional)</p>
                    <p id="modal-reason-user" class="text-xs text-white italic">Keine Info</p>
                </div>

                <div id="admin-note-area" class="bg-zinc-900 p-3 rounded-xl border border-zinc-700">
                    <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">Anmerkung</p>
                    <textarea id="modal-reason-admin" class="w-full bg-zinc-800 text-white text-xs p-2 rounded-lg outline-none" rows="2" placeholder="Noch keine Anmerkung vorhanden..."></textarea>
                    <button id="btn-save-note" onclick="saveAdminNote()" class="hidden w-full mt-2 bg-yellow-500 text-black text-[9px] font-black py-2 rounded-lg uppercase">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-[10000] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-zinc-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl border border-zinc-700">
            <h3 class="text-yellow-500 font-black uppercase text-lg mb-2">Best√§tigung</h3>
            <p id="confirm-message" class="text-sm text-zinc-300 mb-6"></p>
            <div class="flex gap-3">
                <button onclick="cancelConfirm()" class="flex-1 bg-zinc-700 text-white py-3 rounded-xl font-bold text-sm">Abbrechen</button>
                <button id="confirm-yes-btn" onclick="confirmAction()" class="flex-1 bg-yellow-500 text-black py-3 rounded-xl font-bold text-sm">Best√§tigen</button>
            </div>
        </div>
    </div>

    <!-- Input Modal (replaces prompt()) -->
    <div id="input-modal" class="hidden fixed inset-0 z-[10000] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-zinc-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl border border-zinc-700">
            <h3 id="input-modal-title" class="text-yellow-500 font-black uppercase text-lg mb-1">Eingabe</h3>
            <p id="input-modal-label" class="text-xs text-zinc-400 mb-3"></p>
            <input type="text" id="input-modal-field" placeholder="..." class="w-full bg-zinc-900 text-white text-sm p-3 rounded-xl border border-zinc-700 outline-none focus:border-yellow-500 mb-4">
            <div class="flex gap-3">
                <button onclick="cancelInput()" class="flex-1 bg-zinc-700 text-white py-3 rounded-xl font-bold text-sm">Abbrechen</button>
                <button onclick="submitInput()" class="flex-1 bg-yellow-500 text-black py-3 rounded-xl font-bold text-sm">OK</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="app-container" class="min-h-screen pb-20">
        
        <!-- Login Screen -->
        <div id="auth-screen" class="fixed inset-0 bg-black flex flex-col items-center justify-center p-6 z-50">
            <div class="w-full max-w-sm">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">üìÖ</div>
                    <h1 class="text-3xl font-black text-yellow-500 mb-1">SPRINGERPLAN</h1>
                    <p class="text-zinc-500 text-xs font-bold uppercase">V4.2</p>
                </div>
                
                <div class="bg-zinc-900 p-6 rounded-[2rem] shadow-2xl border border-zinc-800">
                    <input id="email" type="email" placeholder="E-Mail" class="w-full mb-3 p-3 bg-zinc-800 text-white rounded-xl text-sm outline-none focus:ring-2 focus:ring-yellow-500 border border-zinc-700">
                    <input id="password" type="password" placeholder="Passwort" class="w-full mb-3 p-3 bg-zinc-800 text-white rounded-xl text-sm outline-none focus:ring-2 focus:ring-yellow-500 border border-zinc-700">
                    
                    <div id="signup-fields" class="hidden space-y-3 mb-3">
                        <input id="display_name" type="text" placeholder="Dein Name" class="w-full p-3 bg-zinc-800 text-white rounded-xl text-sm outline-none focus:ring-2 focus:ring-yellow-500 border border-zinc-700">
                        <input id="store_number" type="text" placeholder="Filiale (z.B. 1234)" class="w-full p-3 bg-zinc-800 text-white rounded-xl text-sm outline-none focus:ring-2 focus:ring-yellow-500 border border-zinc-700">
                        <input id="reg_code" type="text" placeholder="Registrierungs-Code" class="w-full p-3 bg-zinc-800 text-white rounded-xl text-sm outline-none focus:ring-2 focus:ring-yellow-500 border border-zinc-700">
                    </div>
                    
                    <button id="auth-btn-main" onclick="handleAuthAction()" class="w-full bg-yellow-500 text-black font-black uppercase py-3 rounded-xl text-sm mb-3">Login</button>
                    <button id="toggle-auth-btn" onclick="toggleAuthMode()" class="w-full text-zinc-500 text-xs underline">Konto erstellen</button>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            
            <!-- Header -->
            <div class="bg-zinc-900 p-4 flex justify-between items-center border-b border-zinc-800 sticky top-0 z-40">
                <div>
                    <div class="text-sm font-black text-yellow-500 uppercase" id="user-display-name">User</div>
                    <div class="text-[9px] text-zinc-500 font-bold" id="user-store-info">Filiale ‚Äî</div>
                </div>
                <button onclick="handleLogout()" class="bg-zinc-800 text-white px-4 py-2 rounded-lg font-bold text-[9px] uppercase">Logout</button>
            </div>

            <!-- Admin Warning Banner (conditionally shown) -->
            <div id="admin-warning-banner" class="hidden bg-gradient-to-r from-red-600 to-orange-600 p-3 text-center text-white font-black text-[9px] uppercase">
                ‚ö†Ô∏è Admin-Modus aktiv
            </div>

            <!-- Pending Approvals Banner (Admin only) -->
            <div id="user-approval-banner" class="hidden bg-gradient-to-r from-blue-600 to-purple-600 p-3 text-center">
                <div class="text-white font-black text-[9px] uppercase mb-2">üîî Neue Benutzer warten auf Freischaltung</div>
                <div id="user-approval-list" class="text-xs"></div>
            </div>

            <!-- Pending Requests Banner (Admin only) -->
            <div id="admin-request-banner" class="hidden bg-gradient-to-r from-yellow-500 to-orange-500 p-3">
                <div class="text-black font-black text-[9px] uppercase mb-2 text-center">üìã Anfragen</div>
                <div id="admin-list" class="space-y-2"></div>
            </div>

            <!-- Main Content -->
            <div class="p-4 space-y-6">
                
                <!-- Calendar -->
                <div class="bg-zinc-900 p-5 rounded-[2rem] border border-zinc-800">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="changeMonth(-1)" class="bg-zinc-800 text-white px-4 py-2 rounded-xl font-bold">‚óÄ</button>
                        <h2 id="current-month" class="text-lg font-black text-yellow-500 uppercase"></h2>
                        <button onclick="changeMonth(1)" class="bg-zinc-800 text-white px-4 py-2 rounded-xl font-bold">‚ñ∂</button>
                    </div>
                    
                    <div class="day-grid text-[9px] text-zinc-500 font-bold uppercase mb-2">
                        <div class="text-center">Mo</div>
                        <div class="text-center">Di</div>
                        <div class="text-center">Mi</div>
                        <div class="text-center">Do</div>
                        <div class="text-center">Fr</div>
                        <div class="text-center">Sa</div>
                        <div class="text-center">So</div>
                    </div>
                    
                    <div id="calendar" class="day-grid"></div>
                </div>

                <!-- Legend -->
                <div class="bg-zinc-900 p-4 rounded-2xl border border-zinc-800">
                    <h3 class="text-zinc-500 font-black text-[9px] uppercase mb-3">Legende</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="legend-item"><div class="legend-box day-free"></div><span>Frei</span></div>
                        <div class="legend-item"><div class="legend-box day-busy"></div><span>Gebucht</span></div>
                        <div class="legend-item"><div class="legend-box day-pending"></div><span>Ausstehend</span></div>
                        <div class="legend-item"><div class="legend-box day-vacation"></div><span>Urlaub</span></div>
                        <div class="legend-item"><div class="legend-box day-sick"></div><span>Krank</span></div>
                        <div class="legend-item"><div class="legend-box day-planned-free"></div><span>Geplant Frei</span></div>
                    </div>
                </div>

                <!-- Bookings List -->
                <div class="bg-zinc-900 p-4 rounded-2xl border border-zinc-800">
                    <h3 class="text-zinc-500 font-black text-[9px] uppercase mb-3">Meine Buchungen</h3>
                    <div id="booking-list" class="space-y-2"></div>
                    <button id="expand-bookings-btn" class="hidden w-full mt-3 bg-zinc-800 text-white py-2 rounded-xl font-bold text-[9px] uppercase expand-button" onclick="toggleBookingsList()">
                        <span id="expand-bookings-text">Mehr anzeigen</span>
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Action Bar -->
    <div id="action-bar" class="flex gap-2">
        <button onclick="quickBook()" class="flex-1 bg-yellow-500 text-black font-black uppercase py-3 rounded-xl text-xs">Buchen</button>
        <button onclick="clearSelection()" class="bg-zinc-800 text-white font-black uppercase py-3 px-4 rounded-xl text-xs">‚úï</button>
    </div>

    <!-- Admin Action Bar (conditionally shown) -->
    <div id="admin-action-bar" class="hidden fixed bottom-[calc(90px+env(safe-area-inset-bottom))] left-1/2 -translate-x-1/2 w-[92%] max-w-[400px] bg-zinc-900 p-3 rounded-2xl border-2 border-yellow-500 shadow-2xl z-[9998]">
        <div class="text-yellow-500 font-black text-[8px] uppercase mb-2 text-center">Admin-Aktionen</div>
        <div class="flex gap-2 flex-wrap justify-center">
            <button onclick="adminAction('urlaub')" class="bg-blue-600 text-white px-3 py-2 rounded-lg font-black text-[9px] uppercase">Urlaub</button>
            <button onclick="adminAction('krank')" class="bg-red-900 text-white px-3 py-2 rounded-lg font-black text-[9px] uppercase">Krank</button>
            <button onclick="adminAction('planned')" class="bg-purple-600 text-white px-3 py-2 rounded-lg font-black text-[9px] uppercase">Gepl. Frei</button>
            <button onclick="adminAction('frei')" class="bg-green-600 text-white px-3 py-2 rounded-lg font-black text-[9px] uppercase">Freigeben</button>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        const SUPABASE_URL = 'https://nbhhctvuysrykjytxsdt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5iaGhjdHZ1eXNyeWtqeXR4c2R0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcxMzc2NTgsImV4cCI6MjA1MjcxMzY1OH0.1S_z1VC-Gzl1o9NlJjTiMLuYZn0KT0pwYzCdDzQ3Yrc';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const ADMIN_EMAIL = 'bierflo1@gmail.com';
        const MASTER_REG_CODE = 'GIFTUN24';

        const EJS_PUBLIC_KEY = 'TYg1PoVwcFb1i9yF1';
        const EJS_SERVICE = 'service_zqf0t8o';
        const EJS_USER_TEMPLATE = 'template_yrydtrx';
        const EJS_ADMIN_TEMPLATE = 'template_9eixjsb';

        // ============================================
        // STATE
        // ============================================
        
        let currentUser = null;
        let allBookings = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDates = [];
        let currentDetailBooking = null;
        let confirmCallback = null;
        let inputCallback = null;
        let bookingsExpanded = false;
        let realtimeChannel = null;

        // Pull-to-Refresh Variables
        let pullStartY = 0;
        let pullCurrentY = 0;
        let isPulling = false;
        let isRefreshing = false;

        // ============================================
        // INIT
        // ============================================

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            checkOnlineStatus();
            window.addEventListener('online', () => updateOnlineStatus(true));
            window.addEventListener('offline', () => updateOnlineStatus(false));
            
            // Setup Pull-to-Refresh
            setupPullToRefresh();
        });

        // ============================================
        // PULL-TO-REFRESH FUNCTIONALITY
        // ============================================

        function setupPullToRefresh() {
            const dashboard = document.getElementById('dashboard');
            const indicator = document.getElementById('pull-refresh-indicator');
            const text = document.getElementById('pull-refresh-text');

            dashboard.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0 && !isRefreshing) {
                    pullStartY = e.touches[0].clientY;
                    isPulling = true;
                }
            }, { passive: true });

            dashboard.addEventListener('touchmove', (e) => {
                if (!isPulling || isRefreshing) return;

                pullCurrentY = e.touches[0].clientY;
                const pullDistance = pullCurrentY - pullStartY;

                if (pullDistance > 0 && pullDistance < 100) {
                    indicator.style.opacity = pullDistance / 100;
                    indicator.style.transform = `translateY(${pullDistance - 60}px)`;
                    text.textContent = 'Ziehen zum Aktualisieren...';
                } else if (pullDistance >= 100) {
                    indicator.classList.add('visible');
                    text.textContent = 'Loslassen zum Aktualisieren';
                }
            }, { passive: true });

            dashboard.addEventListener('touchend', async () => {
                if (!isPulling || isRefreshing) return;

                const pullDistance = pullCurrentY - pullStartY;

                if (pullDistance >= 100) {
                    await triggerRefresh();
                } else {
                    resetPullToRefresh();
                }

                isPulling = false;
                pullStartY = 0;
                pullCurrentY = 0;
            }, { passive: true });
        }

        async function triggerRefresh() {
            if (isRefreshing) return;

            isRefreshing = true;
            const indicator = document.getElementById('pull-refresh-indicator');
            const text = document.getElementById('pull-refresh-text');

            indicator.classList.add('refreshing');
            text.textContent = 'Aktualisiere...';

            try {
                await fetchAndRender();
                showToast('‚úÖ Aktualisiert', 'success');
            } catch (error) {
                showToast('‚ùå Fehler beim Aktualisieren', 'error');
            }

            setTimeout(() => {
                resetPullToRefresh();
                isRefreshing = false;
            }, 500);
        }

        function resetPullToRefresh() {
            const indicator = document.getElementById('pull-refresh-indicator');
            indicator.classList.remove('visible', 'refreshing');
            indicator.style.opacity = '0';
            indicator.style.transform = 'translateY(-60px)';
        }

        // ============================================
        // REALTIME UPDATES (Supabase)
        // ============================================

        function setupRealtimeUpdates() {
            try {
                // Unsubscribe from previous channel if exists
                if (realtimeChannel) {
                    supabaseClient.removeChannel(realtimeChannel);
                }

                // Subscribe to bookings table changes
                realtimeChannel = supabaseClient
                    .channel('bookings-changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'bookings' },
                        async (payload) => {
                            console.log('Realtime update:', payload);
                            
                            // Silently refresh data in background
                            try {
                                await fetchAndRender(true); // true = silent mode, no toast
                            } catch (err) {
                                console.error('Error during realtime refresh:', err);
                            }
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('‚úÖ Realtime updates aktiv');
                        } else if (status === 'CHANNEL_ERROR') {
                            console.warn('‚ö†Ô∏è Realtime updates nicht verf√ºgbar - Pull-to-Refresh nutzen');
                        }
                    });

                // Also listen to profile changes for admin
                if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                    supabaseClient
                        .channel('profile-changes')
                        .on(
                            'postgres_changes',
                            { event: '*', schema: 'public', table: 'profiles' },
                            async () => {
                                try {
                                    await fetchAndRender(true);
                                } catch (err) {
                                    console.error('Error during profile refresh:', err);
                                }
                            }
                        )
                        .subscribe((status) => {
                            if (status === 'SUBSCRIBED') {
                                console.log('‚úÖ Profile updates aktiv');
                            }
                        });
                }
            } catch (err) {
                // Realtime is optional - app works fine with pull-to-refresh
                console.warn('Realtime updates konnten nicht aktiviert werden:', err);
            }
        }

        // ============================================
        // AUTH & USER
        // ============================================

        async function checkAuth() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    document.getElementById('auth-screen').classList.remove('hidden');
                    return;
                }

                currentUser = session.user;
                const { data: profile, error } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();

                if (error) {
                    console.error('Profil-Fehler:', error);
                    showToast('‚ùå Fehler beim Laden des Profils', 'error');
                    await supabaseClient.auth.signOut();
                    document.getElementById('auth-screen').classList.remove('hidden');
                    return;
                }

                if (!profile || !profile.is_approved) {
                    showToast('‚è≥ Dein Account wurde noch nicht freigeschaltet.', 'warning');
                    await supabaseClient.auth.signOut();
                    document.getElementById('auth-screen').classList.remove('hidden');
                    return;
                }

                document.getElementById('user-display-name').innerText = profile.display_name || currentUser.email;
                document.getElementById('user-store-info').innerText = `Filiale ${profile.store_number || '‚Äî'}`;

                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');

                if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                    document.getElementById('admin-warning-banner').classList.remove('hidden');
                }

                await fetchAndRender();
                
                // Setup realtime updates after initial load (optional, doesn't block app)
                setupRealtimeUpdates();
            } catch (err) {
                console.error('Auth-Fehler:', err);
                showToast('‚ùå Verbindungsfehler - Bitte erneut versuchen', 'error');
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        }

        async function fetchAndRender(silent = false) {
            try {
                const { data, error } = await supabaseClient.from('bookings').select('*');
                
                if (error) {
                    console.error('Fehler beim Laden der Buchungen:', error);
                    if (!silent) {
                        showToast('‚ö†Ô∏è Daten konnten nicht geladen werden', 'error');
                    }
                    return;
                }
                
                allBookings = data || [];
                renderCalendar();
                renderLists(allBookings);

                if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                    await renderUserApproval();
                }

                if (!silent) {
                    // Only show toast if not silent
                    // (silent is used for background realtime updates)
                }
            } catch (err) {
                console.error('Netzwerkfehler:', err);
                if (!silent) {
                    showToast('‚ùå Netzwerkfehler - Bitte Pull-to-Refresh verwenden', 'error');
                }
            }
        }

        // ============================================
        // CALENDAR RENDERING
        // ============================================

        function renderCalendar() {
            const cal = document.getElementById('calendar');
            cal.innerHTML = '';
            
            document.getElementById('current-month').innerText = new Date(currentYear, currentMonth).toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const offset = (firstDay === 0 ? 6 : firstDay - 1);

            for (let i = 0; i < offset; i++) {
                const empty = document.createElement('div');
                cal.appendChild(empty);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const div = document.createElement('div');
                div.className = 'calendar-day';
                div.innerHTML = `<span>${day}</span>`;

                const bookingsForDay = allBookings.filter(b => b.requested_date === dateStr);
                const isPast = new Date(dateStr) < new Date(new Date().toDateString());

                if (bookingsForDay.length > 0) {
                    const primary = bookingsForDay[0];
                    if (primary.booking_type === 'vacation') div.classList.add('day-vacation');
                    else if (primary.booking_type === 'sick') div.classList.add('day-sick');
                    else if (primary.booking_type === 'planned_free') div.classList.add('day-planned-free');
                    else if (primary.status === 'pending') div.classList.add('day-pending');
                    else if (primary.status === 'confirmed') div.classList.add('day-busy');

                    if (bookingsForDay.length > 1) {
                        div.innerHTML += `<div class="store-label">${bookingsForDay.map(b => b.store_number).join(', ')}</div>`;
                    } else {
                        div.innerHTML += `<div class="store-label">${primary.store_number}</div>`;
                    }

                    div.onclick = () => openModal(primary);
                } else {
                    div.classList.add('day-free');
                    if (isPast) {
                        div.classList.add('day-disabled');
                    } else {
                        div.onclick = () => toggleDateSelection(dateStr, div);
                    }
                }

                if (selectedDates.includes(dateStr)) div.classList.add('day-selected');

                cal.appendChild(div);
            }
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            renderCalendar();
        }

        function toggleDateSelection(date, elem) {
            const idx = selectedDates.indexOf(date);
            if (idx > -1) {
                selectedDates.splice(idx, 1);
                elem.classList.remove('day-selected');
            } else {
                selectedDates.push(date);
                elem.classList.add('day-selected');
            }

            const actionBar = document.getElementById('action-bar');
            const adminActionBar = document.getElementById('admin-action-bar');
            
            if (selectedDates.length > 0) {
                actionBar.classList.add('visible');
                if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                    adminActionBar.classList.remove('hidden');
                }
            } else {
                actionBar.classList.remove('visible');
                adminActionBar.classList.add('hidden');
            }
        }

        function clearSelection() {
            selectedDates = [];
            document.getElementById('action-bar').classList.remove('visible');
            document.getElementById('admin-action-bar').classList.add('hidden');
            renderCalendar();
        }

        // ============================================
        // BOOKING ACTIONS
        // ============================================

        function quickBook() {
            if (selectedDates.length === 0) return;

            showInput(
                'Buchung anfragen',
                'Grund (optional):',
                'z.B. "Arzttermin", "Familienfest"...',
                async (reason) => {
                    const insData = selectedDates.map(d => ({
                        requested_date: d,
                        user_id: currentUser.id,
                        user_email: currentUser.email,
                        display_name: document.getElementById('user-display-name').innerText,
                        store_number: document.getElementById('user-store-info').innerText.replace('Filiale ', ''),
                        status: 'pending',
                        booking_type: 'request',
                        reason_user: reason || null
                    }));

                    await supabaseClient.from('bookings').insert(insData);

                    emailjs.init(EJS_PUBLIC_KEY);
                    await emailjs.send(EJS_SERVICE, EJS_ADMIN_TEMPLATE, {
                        user_name: insData[0].display_name,
                        store_number: insData[0].store_number,
                        date: selectedDates.join(', '),
                        reason: reason || 'Keine Angabe'
                    });

                    showToast('‚úÖ Anfrage gesendet', 'success');
                    clearSelection();
                }
            );
        }

        async function adminAction(type) {
            if (selectedDates.length === 0) return;

            const insData = (bType, label, user) => selectedDates.map(d => ({
                requested_date: d,
                user_id: currentUser.id,
                user_email: user,
                display_name: label,
                store_number: document.getElementById('user-store-info').innerText.replace('Filiale ', ''),
                status: 'confirmed',
                booking_type: bType,
                reason_admin: `Admin: ${label}`
            }));

            if (type === 'urlaub') {
                showConfirm(
                    `${selectedDates.length} Tage als URLAUB markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('vacation', 'URLAUB', 'Admin'));
                        showToast('‚úÖ Urlaub eingetragen', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'krank') {
                showConfirm(
                    `${selectedDates.length} Tage als KRANK markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('sick', 'KRANK', 'Admin'));
                        showToast('‚úÖ Krankmeldung eingetragen', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'planned') {
                showConfirm(
                    `${selectedDates.length} Tage als GEPLANT FREI markieren?`,
                    async () => {
                        await supabaseClient.from('bookings').insert(insData('planned_free', 'FREI', 'Admin'));
                        showToast('‚úÖ Geplant Frei eingetragen', 'success');
                        clearSelection();
                    }
                );
            } else if (type === 'frei') {
                showConfirm(
                    `${selectedDates.length} Tage FREIGEBEN (alle Buchungen l√∂schen)?`,
                    async () => {
                        await supabaseClient.from('bookings').delete().in('requested_date', selectedDates);
                        showToast('‚úÖ Tage freigegeben', 'success');
                        clearSelection();
                    }
                );
            }
        }

        // ============================================
        // USER APPROVAL (Admin)
        // ============================================

        async function renderUserApproval() {
            const list = document.getElementById('user-approval-list');
            const banner = document.getElementById('user-approval-banner');
            const { data: users } = await supabaseClient.from('profiles').select('*').eq('is_approved', false);
            
            if (!users || users.length === 0) { 
                list.innerHTML = '<p class="text-[9px] text-zinc-600">Keine neuen User</p>'; 
                banner.classList.add('hidden');
                return; 
            }

            banner.classList.remove('hidden');
            list.innerHTML = '';
            users.forEach(u => {
                list.innerHTML += `<div class="bg-white text-black p-3 rounded-xl flex justify-between items-center mb-2"><div class="text-left font-black text-[8px]">${u.display_name}<br><span class="font-normal">Filiale ${u.store_number}</span></div><button onclick="approveUser('${u.id}')" class="bg-blue-600 text-white px-3 py-2 rounded-lg font-black uppercase text-[7px]">OK</button></div>`;
            });
        }

        async function approveUser(uid) { 
            await supabaseClient.from('profiles').update({ is_approved: true }).eq('id', uid); 
            showToast('‚úÖ User freigeschaltet', 'success');
            await fetchAndRender(); 
        }

        // ============================================
        // BOOKING LISTS
        // ============================================

        function renderLists(data) {
            const uL = document.getElementById('booking-list');
            const aL = document.getElementById('admin-list');
            const aBanner = document.getElementById('admin-request-banner');
            
            uL.innerHTML = ''; 
            
            // Admin list
            const pending = data.filter(x => x.status === 'pending');
            
            if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                if (pending.length > 0) {
                    aBanner.classList.remove('hidden');
                    aL.innerHTML = '';
                    pending.forEach(b => {
                        aL.innerHTML += `<div class="bg-white text-black p-3 rounded-2xl flex justify-between items-center text-[8px] font-bold"><div>${b.requested_date}<br><span class="text-zinc-500">${b.display_name}</span></div><div class="flex gap-1"><button onclick="processRequest(this, '${b.id}','confirmed','${b.user_email}','${b.requested_date}')" class="bg-green-600 text-white px-3 py-2 rounded-lg">‚úì</button><button onclick="processRequest(this, '${b.id}','rejected','${b.user_email}','${b.requested_date}')" class="bg-red-600 text-white px-3 py-2 rounded-lg">X</button></div></div>`;
                    });
                } else {
                    aBanner.classList.add('hidden');
                }
            }
            
            // User bookings with collapsible functionality
            const userBookings = data.filter(x => x.user_id === currentUser.id).sort((a,b) => b.requested_date.localeCompare(a.requested_date));
            const expandBtn = document.getElementById('expand-bookings-btn');
            
            if (userBookings.length === 0) {
                uL.innerHTML = '<p class="text-[9px] text-zinc-600">Noch keine Buchungen</p>';
                expandBtn.classList.add('hidden');
            } else if (userBookings.length <= 5) {
                // Show all bookings if 5 or fewer
                userBookings.forEach(b => {
                    uL.innerHTML += createBookingItem(b);
                });
                expandBtn.classList.add('hidden');
            } else {
                // Show first 5, hide rest
                userBookings.forEach((b, idx) => {
                    const hiddenClass = (!bookingsExpanded && idx >= 5) ? 'booking-item-hidden' : '';
                    uL.innerHTML += createBookingItem(b, hiddenClass);
                });
                expandBtn.classList.remove('hidden');
                updateExpandButtonText();
            }
        }

        function createBookingItem(booking, extraClass = '') {
            return `<div onclick='openModal(${JSON.stringify(booking).replace(/'/g, "&apos;")})' class="p-4 bg-zinc-800/30 rounded-2xl flex justify-between items-center text-[9px] font-bold border border-zinc-800 cursor-pointer ${extraClass}"><div>${booking.requested_date}</div><div class="uppercase text-yellow-500">${booking.status}</div></div>`;
        }

        function toggleBookingsList() {
            bookingsExpanded = !bookingsExpanded;
            const items = document.querySelectorAll('.booking-item-hidden');
            
            items.forEach(item => {
                if (bookingsExpanded) {
                    item.classList.remove('booking-item-hidden');
                } else {
                    item.classList.add('booking-item-hidden');
                }
            });
            
            updateExpandButtonText();
        }

        function updateExpandButtonText() {
            const text = document.getElementById('expand-bookings-text');
            text.textContent = bookingsExpanded ? 'Weniger anzeigen' : 'Mehr anzeigen';
        }

        // ============================================
        // REQUEST PROCESSING
        // ============================================

        async function processRequest(btn, id, status, email, date) {
            if (status === 'rejected') {
                showInput(
                    'Anfrage ablehnen',
                    'Ablehnungsgrund (optional):',
                    'z.B. "An diesem Tag bereits verplant..."',
                    async (reason) => {
                        btn.innerText = '..';
                        await supabaseClient.from('bookings').update({ status, reason_admin: reason }).eq('id', id);
                        
                        if (email) {
                            emailjs.init(EJS_PUBLIC_KEY);
                            const adminNote = reason ? `Grund: ${reason}` : '';
                            await emailjs.send(EJS_SERVICE, EJS_USER_TEMPLATE, { 
                                email: email, 
                                status_text: 'ABGELEHNT', 
                                date: date,
                                admin_note: adminNote
                            });
                        }
                        showToast('‚úÖ Anfrage abgelehnt', 'success');
                        await fetchAndRender();
                    }
                );
            } else {
                btn.innerText = '..';
                await supabaseClient.from('bookings').update({ status }).eq('id', id);
                
                if (email) {
                    emailjs.init(EJS_PUBLIC_KEY);
                    await emailjs.send(EJS_SERVICE, EJS_USER_TEMPLATE, { 
                        email: email, 
                        status_text: 'BEST√ÑTIGT', 
                        date: date,
                        admin_note: ''
                    });
                }
                showToast('‚úÖ Anfrage best√§tigt', 'success');
                await fetchAndRender();
            }
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================

        function openModal(booking) {
            currentDetailBooking = booking;
            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('modal-date').innerText = booking.requested_date;
            document.getElementById('modal-user').innerText = `${booking.display_name} (${booking.status})`;
            document.getElementById('modal-reason-user').innerText = booking.reason_user || 'Keine Info';
            
            const adminArea = document.getElementById('admin-note-area');
            const adminTextarea = document.getElementById('modal-reason-admin');
            const saveBtn = document.getElementById('btn-save-note');

            if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                adminArea.classList.remove('hidden');
                adminTextarea.value = booking.reason_admin || '';
                adminTextarea.oninput = () => { saveBtn.classList.remove('hidden'); };
            } else {
                adminArea.classList.add('hidden');
            }
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
            currentDetailBooking = null;
        }

        async function saveAdminNote() {
            const note = document.getElementById('modal-reason-admin').value;
            await supabaseClient.from('bookings').update({ reason_admin: note }).eq('id', currentDetailBooking.id);
            showToast('‚úÖ Anmerkung gespeichert', 'success');
            document.getElementById('btn-save-note').classList.add('hidden');
            await fetchAndRender();
        }

        // ============================================
        // CONFIRM & INPUT MODALS
        // ============================================

        function showConfirm(message, callback) {
            document.getElementById('confirm-message').innerText = message;
            document.getElementById('confirm-modal').classList.remove('hidden');
            confirmCallback = callback;
        }

        function cancelConfirm() {
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmCallback = null;
        }

        async function confirmAction() {
            if (confirmCallback) {
                await confirmCallback();
                cancelConfirm();
            }
        }

        function showInput(title, label, placeholder, callback) {
            document.getElementById('input-modal-title').innerText = title;
            document.getElementById('input-modal-label').innerText = label;
            const field = document.getElementById('input-modal-field');
            field.placeholder = placeholder;
            field.value = '';
            document.getElementById('input-modal').classList.remove('hidden');
            inputCallback = callback;
            setTimeout(() => field.focus(), 100);
        }

        function cancelInput() {
            document.getElementById('input-modal').classList.add('hidden');
            inputCallback = null;
        }

        async function submitInput() {
            const value = document.getElementById('input-modal-field').value;
            if (inputCallback) {
                await inputCallback(value);
                cancelInput();
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function setBtnLoading(btnId, isLoading, text = '...') {
            const btn = document.getElementById(btnId);
            if (isLoading) {
                btn.classList.add('btn-loading');
                btn.innerHTML = `<span class="spinner"></span>${text}`;
            } else {
                btn.classList.remove('btn-loading');
                btn.innerHTML = text;
            }
        }

        function checkOnlineStatus() {
            updateOnlineStatus(navigator.onLine);
        }

        function updateOnlineStatus(isOnline) {
            const indicator = document.getElementById('offline-indicator');
            if (isOnline) {
                indicator.classList.add('hidden');
            } else {
                indicator.classList.remove('hidden');
            }
        }

        // ============================================
        // AUTH FUNCTIONS
        // ============================================

        async function handleAuthAction() {
            setBtnLoading('auth-btn-main', true, "...");
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                if (document.getElementById('signup-fields').classList.contains('hidden')) {
                    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) throw error; 
                    else location.reload();
                } else {
                    const name = document.getElementById('display_name').value;
                    const store = document.getElementById('store_number').value;
                    const code = document.getElementById('reg_code').value;
                    
                    if (code.toUpperCase() !== MASTER_REG_CODE) throw new Error("Registrierungs-Code falsch");
                    
                    const { error } = await supabaseClient.auth.signUp({ 
                        email, 
                        password, 
                        options: { data: { display_name: name, store_number: store } } 
                    });
                    
                    if (error) throw error;
                    
                    emailjs.init(EJS_PUBLIC_KEY);
                    await emailjs.send(EJS_SERVICE, EJS_ADMIN_TEMPLATE, { 
                        user_name: name, 
                        store_number: store, 
                        date: "NEUE ANMELDUNG", 
                        reason: "Wartet auf Freischaltung" 
                    });
                    
                    showToast('‚úÖ Registriert! Warte auf Freischaltung.', 'success');
                    location.reload(); 
                }
            } catch (err) { 
                showToast('‚ùå ' + err.message, 'error');
                setBtnLoading('auth-btn-main', false); 
            }
        }

        function toggleAuthMode() { 
            const isHidden = document.getElementById('signup-fields').classList.toggle('hidden'); 
            document.getElementById('toggle-auth-btn').innerText = isHidden ? "Konto erstellen" : "Zum Login"; 
            document.getElementById('auth-btn-main').innerText = isHidden ? "Login" : "Registrieren"; 
        }

        async function handleLogout() { 
            try {
                // Cleanup realtime subscriptions
                if (realtimeChannel) {
                    await supabaseClient.removeChannel(realtimeChannel);
                }
            } catch (err) {
                console.warn('Fehler beim Cleanup:', err);
            }
            
            await supabaseClient.auth.signOut(); 
            location.reload(); 
        }
    </script>
</body>
</html>
